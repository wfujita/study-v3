# 数学ドリルの解答ファイル処理フロー

このドキュメントは、数学ドリルの結果送信時に添付される解答ファイルがどのように処理されるのかをまとめたものです。

## フロントエンドでの処理

- `app/static/math.html` のファイル選択 UI で画像などのファイルを選ぶと、`FileReader.readAsDataURL` によってファイル全体が Data URL (base64 文字列) として読み込まれます。
- 読み込みが成功すると、ファイル名 (`name`)、ブラウザが推測した MIME タイプ (`type`)、Data URL (`data`) を含むオブジェクトが `state.upload` に格納され、採点結果を送信するリクエストに同梱されます。
- ファイルサイズが 10MB を超える場合はフロントエンドで弾かれ、アップロード要求は送信されません。

## バックエンドでの処理

- Flask アプリケーションの `/api/results` エンドポイントでは、リクエストボディの `answerUpload` フィールドを `_persist_answer_upload` 関数で検証・保存します。
- 関数内で Data URL のヘッダーを解析し、base64 エンコード部分を復号して元のバイナリに戻します。復号に失敗した場合や 10MB を超える場合は保存を中止します。
- 保存する際は、元のファイル名から安全なファイル名を生成し、ランダムなサフィックスを付与して `data/<subject>/uploads/` 配下に書き出します。
- 保存後は、元の名前・MIME タイプ・サイズ・保存先ファイル名・ダウンロード用 URL を含むメタデータをレスポンスに含め、結果履歴やダウンロードリンクの表示に利用します。

## 解析について

現状、アップロードされたファイルの内容を解析して自動採点する処理は行っていません。サーバー側ではファイルの整合性とサイズを確認した上で安全に保存し、管理者が後からダウンロードできるようにすることを目的としています。
