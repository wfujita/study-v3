<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>成績ダッシュボード｜並べ替えクイズ</title>
  <style>
    :root{ --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --border:#1f2937; --accent:#3b82f6; --warn:#ef4444; --ok:#22c55e }
    *{ box-sizing:border-box }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif }
    header{ position:sticky; top:0; background:rgba(17,24,39,.9); backdrop-filter:saturate(150%) blur(6px); border-bottom:1px solid var(--border); z-index:10 }
    .container{ width:min(1400px, calc(100vw - 48px)); margin:0 auto; padding:16px }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
    .row.filters{ align-items:flex-end }
    .pill{ display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; border:1px solid #334155; background:#0b1220; color:#cbd5e1; font-size:12px }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px; margin:16px 0 }
    .grid{ display:grid; gap:12px }
    .grid.cols-3{ grid-template-columns: repeat(3,1fr) }
    .grid.cols-2{ grid-template-columns: repeat(2,1fr) }
    .grid.cols-1{ grid-template-columns: 1fr }
    .stat{ background:#0b1220; border:1px solid #334155; border-radius:12px; padding:12px }
    .muted{ color:var(--muted) }
    table{ width:100%; border-collapse: collapse; }
    th,td{ padding:8px 10px; border-bottom:1px solid #334155; vertical-align:top }
    th{ text-align:left; color:#cbd5e1; background:#0b1220; position:sticky; top:0 }
    tr:hover td{ background:#0b1220 }
    .badge{ padding:2px 8px; border-radius:999px; border:1px solid #334155; font-size:12px }
    .ok{ color:var(--ok) } .ng{ color:var(--warn) }
    select,input{ background:#0b1220; color:#e5e7eb; border:1px solid #334155; border-radius:10px; padding:8px 10px }
    button{ border:none; border-radius:10px; padding:10px 16px; font-weight:600; cursor:pointer; font-size:14px }
    button.primary{ background:var(--accent); color:#fff; box-shadow:0 10px 30px rgba(59,130,246,.25); }
    button[disabled]{ opacity:.6; cursor:not-allowed; }
    .right{ margin-left:auto }
    .center{ text-align:center }
    .stage-grid{ display:grid; gap:12px; grid-template-columns:repeat(2,minmax(0,1fr)); align-items:start; }
    .stage-col{ background:#0b1220; border:1px solid #334155; border-radius:12px; padding:12px; display:flex; flex-direction:column; max-height:340px }
    .stage-col h4{ margin:0 0 8px; font-size:14px; display:flex; align-items:center; justify-content:space-between }
    .stage-col h4 span{ font-size:11px; color:var(--muted) }
    .stage-col .stage-desc{ margin:0 0 10px; font-size:11px; color:var(--muted); line-height:1.5 }
    .stage-col .stage-scroll{ overflow:auto; flex:1 }
    .stage-col table{ font-size:12px; width:100%; }
    .stage-col th, .stage-col td{ padding:6px 8px }
    .stage-col .empty{ color:var(--muted); font-size:12px; padding:4px 0 }
    @media (max-width: 1024px){
      .grid.cols-3{ grid-template-columns: repeat(2,minmax(0,1fr)); }
    }

    @media (max-width: 768px){
      .container{ width:calc(100vw - 32px); padding:12px }
      header .container{ padding:12px }
      .row.filters{ flex-direction:column; align-items:stretch; gap:12px }
      .row.filters label,
      .row.filters input,
      .row.filters select,
      .row.filters .pill{ width:100% }
      .row.filters .pill{ justify-content:center; margin-left:0 }
      .grid.cols-3,
      .grid.cols-2{ grid-template-columns:1fr }
      .stage-grid{ grid-template-columns:1fr; }
      .stage-col{ max-height:none; }
      .stage-col .stage-scroll{ overflow:visible; max-height:none; }
    }

    @media (max-width: 640px){
      .stage-col table{ border:0; }
      .stage-col thead{ display:none; }
      .stage-col tbody{ display:grid; gap:10px; }
      .stage-col tr{ display:grid; grid-template-columns:minmax(0,1fr); gap:6px; padding:10px; border:1px solid #334155; border-radius:10px; background:#101726; }
      .stage-col td{ border:none; padding:0; display:block; }
      .stage-col td::before{ content:attr(data-label); color:var(--muted); font-weight:600; font-size:11px; display:block; margin-bottom:2px; }
    }

    @media (max-width: 480px){
      body{ font-size:14px }
      h2{ font-size:20px }
      .stage-grid{ grid-template-columns:1fr }
    }

    .form-row{ display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end }
    .field{ display:flex; flex-direction:column; gap:6px; font-size:12px; color:var(--muted); min-width:160px }
    .field input, .field select{ width:100%; font-size:14px }
    .notice{ margin-top:12px; font-size:13px }
    .notice.ok{ color:var(--ok) }
    .notice.ng{ color:var(--warn) }
  </style>
</head>
<body>
  <header>
    <div class="container row">
      <div>
        <h2 style="margin:0">成績ダッシュボード</h2>
        <div class="muted" style="font-size:12px">ユーザ別集計／単元別／よく間違える問題／最近の解答</div>
      </div>
      <a href="/" class="pill right">⬅ クイズへ戻る</a>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <div class="row filters">
        <label class="row" style="gap:6px">
          <span class="muted">ユーザ</span>
          <select id="user"></select>
        </label>
        <label class="row" style="gap:6px">
          <span class="muted">単元</span>
          <select id="unit"><option value="">（すべて）</option></select>
        </label>
        <label class="row" style="gap:6px">
          <span class="muted">モード</span>
          <select id="mode"><option value="normal">通常</option><option value="review">復習</option></select>
        </label>
        <label class="row" style="gap:6px">
          <span class="muted">表示</span>
          <select id="show"><option value="all">すべて</option><option value="vocab">単語問題</option><option value="reorder">並べ替え問題</option><option value="rewrite">書き換え問題</option></select>
        </label>
        <input id="search" placeholder="問題検索（日本語/英語/ID）" style="min-width:220px" />
        <span class="pill right" id="last-updated">更新: --</span>
      </div>
    </section>

    <section class="card" id="sec-reset">
      <h3 style="margin:0 0 8px">学習状況リセット</h3>
      <p class="muted" style="margin:0 0 12px; font-size:13px">対象のユーザと問題IDを指定してステージ履歴を削除します。</p>
      <form id="form-reset" class="form-row">
        <label class="field" style="max-width:220px">
          <span>ユーザ</span>
          <select id="reset-user"></select>
        </label>
        <label class="field" style="max-width:240px">
          <span>問題ID</span>
          <input id="reset-question" list="reset-question-options" placeholder="例: q12" />
          <datalist id="reset-question-options"></datalist>
        </label>
        <button type="submit" class="primary" id="btn-reset">リセットを実行</button>
      </form>
      <div id="reset-result" class="notice muted"></div>
    </section>

    <section class="card" id="sec-level">
      <h3 style="margin:0 0 8px">問題レベル編集</h3>
      <p class="muted" style="margin:0 0 12px; font-size:13px">問題IDを指定してレベルを上書きします。空欄のまま「上書きを削除」を押すと元の設定に戻ります。</p>
      <form id="form-level" class="form-row">
        <label class="field" style="max-width:240px">
          <span>問題ID</span>
          <input id="level-question" list="reset-question-options" placeholder="例: q12" />
        </label>
        <label class="field" style="max-width:160px">
          <span>設定するレベル</span>
          <input id="level-value" placeholder="例: Lv2 または 2" />
        </label>
        <button type="submit" class="primary" id="btn-level-save">レベルを更新</button>
        <button type="button" id="btn-level-clear">上書きを削除</button>
      </form>
      <div id="level-result" class="notice muted"></div>
    </section>

    <section class="grid cols-3">
      <div class="stat"><div class="muted">学習回数</div><div id="st-sessions" style="font-size:24px;font-weight:800">0</div></div>
      <div class="stat"><div class="muted">解答数</div><div id="st-answered" style="font-size:24px;font-weight:800">0</div></div>
      <div class="stat"><div class="muted">平均正答率</div><div id="st-acc" style="font-size:24px;font-weight:800">0%</div></div>
    </section>

    <section class="card">
      <h3 style="margin:0 0 8px">テスト一覧</h3>
      <div style="max-height:340px; overflow:auto">
        <table id="tbl-sessions"><thead><tr><th>開始</th><th>終了</th><th class="center">セット</th><th class="center">正解</th><th class="center">出題</th><th class="center">正答率</th><th class="center">復習</th></tr></thead><tbody></tbody></table>
      </div>
    </section>

    <section class="card">
      <h3 style="margin:0 0 8px">単元別（Unit）</h3>
      <div style="max-height:260px; overflow:auto">
        <table id="tbl-units"><thead><tr><th>単元</th><th class="center">解答</th><th class="center">正答</th><th class="center">誤答</th><th class="center">正答率</th></tr></thead><tbody></tbody></table>
      </div>
    </section>

    <section class="card">
      <h3 style="margin:0 0 8px">最近の解答（最大100件）</h3>
      <div style="max-height:340px; overflow:auto">
        <table id="tbl-recent"><thead><tr><th>日時</th><th>ID</th><th class="center">ランク</th><th class="center">ステージ</th><th class="center">結果</th><th>ユーザ解答</th><th>正解（英語）</th><th>正解（日本語）</th><th>単元</th><th>ユーザ</th></tr></thead><tbody></tbody></table>
      </div>
    </section>

    <section class="card">
      <h3 style="margin:0 0 8px">よく間違える問題（TOP10）</h3>
      <div style="max-height:340px; overflow:auto">
        <table id="tbl-top"><thead><tr><th style="width:60px">回数</th><th>ID</th><th>日本語</th><th>英語</th><th>単元</th><th class="center">ステージ</th><th class="center">誤答/解答</th><th class="center">正答率</th></tr></thead><tbody></tbody></table>
      </div>
    </section>

    <section class="card" id="sec-stages" style="display:none">
      <h3 style="margin:0 0 8px">ステージ進捗</h3>
      <div class="stage-grid" id="stage-grid"></div>
    </section>

    <section class="grid cols-3" id="sec-words">
      <div class="card" id="sec-vocab">
        <h3 style="margin:0 0 8px">単語問題</h3>
        <div style="max-height:340px; overflow:auto">
          <table id="tbl-words-vocab"><thead><tr><th>ID</th><th>日本語</th><th>英語</th><th class="center">レベル</th><th class="center">正答</th><th class="center">誤答</th><th class="center">ランク</th><th class="center">次回</th><th class="center">連続正解</th><th class="center">正答率</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
      <div class="card" id="sec-reorder">
        <h3 style="margin:0 0 8px">並べ替え問題</h3>
        <div style="max-height:340px; overflow:auto">
          <table id="tbl-words-reorder"><thead><tr><th>ID</th><th>日本語</th><th>英語</th><th class="center">レベル</th><th class="center">正答</th><th class="center">誤答</th><th class="center">ランク</th><th class="center">次回</th><th class="center">連続正解</th><th class="center">正答率</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
      <div class="card" id="sec-rewrite">
        <h3 style="margin:0 0 8px">書き換え問題</h3>
        <div style="max-height:340px; overflow:auto">
          <table id="tbl-words-rewrite"><thead><tr><th>ID</th><th>指示</th><th>英語</th><th class="center">レベル</th><th class="center">正答</th><th class="center">誤答</th><th class="center">ランク</th><th class="center">次回</th><th class="center">連続正解</th><th class="center">正答率</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </section>
  </main>

  <script>
    const SUBJECT = 'english';
    const $ = s=>document.querySelector(s);
    const $$ = s=>Array.from(document.querySelectorAll(s));
    const fmt = n=> new Intl.NumberFormat().format(n);
    const pct = x=> (Math.round(x*1000)/10).toFixed(1)+"%";
    const qs  = (obj)=> Object.entries(obj).map(([k,v])=> v!==undefined && v!==''? `${encodeURIComponent(k)}=${encodeURIComponent(v)}`:'' ).filter(Boolean).join('&');

    async function getJSON(path, params={}){
      const merged = { subject: SUBJECT, ...params };
      const url = merged && Object.keys(merged).length? `${path}?${qs(merged)}` : path;
      const res = await fetch(url, {cache:'no-store'});
      if(!res.ok) throw new Error(`fetch ${path} ${res.status}`);
      return await res.json();
    }

    function setResetMessage(text, kind='muted'){
      const box = $('#reset-result');
      if(!box) return;
      box.textContent = text || '';
      box.className = `notice ${kind}`;
    }

    function setLevelMessage(text, kind='muted'){
      const box = $('#level-result');
      if(!box) return;
      box.textContent = text || '';
      box.className = `notice ${kind}`;
    }

    function syncResetUserFromFilter(){
      const filter = $('#user');
      const reset = $('#reset-user');
      if(!filter || !reset) return;
      const value = filter.value;
      if(value && value !== '__all__' && (!reset.value || reset.value === '__all__')){
        reset.value = value;
      }
    }

    function populateResetUsers(users){
      const reset = $('#reset-user');
      if(!reset) return;
      const current = reset.value;
      reset.innerHTML = '<option value="">（ユーザ選択）</option>';
      users.forEach(u=>{
        const opt=document.createElement('option');
        opt.value=u.user;
        opt.textContent=`${u.user}`;
        reset.appendChild(opt);
      });
      if(current && users.some(u=>u.user===current)){
        reset.value=current;
      }else{
        syncResetUserFromFilter();
      }
    }

    function updateResetQuestionList(questionStats){
      const list = $('#reset-question-options');
      if(!list) return;
      list.innerHTML='';
      const seen = new Set();
      questionStats.forEach(q=>{
        const id = q && q.id ? String(q.id) : '';
        if(!id || seen.has(id)) return;
        seen.add(id);
        const opt = document.createElement('option');
        const jp = q && q.jp ? q.jp : '';
        const en = q && q.en ? q.en : '';
        const label = [id, jp || en].filter(Boolean).join('｜');
        opt.value = id;
        opt.textContent = label || id;
        list.appendChild(opt);
      });
    }

    async function loadUsers(){
      const users = await getJSON('/api/admin/users');
      const sel = $('#user'); sel.innerHTML='';
      const optAll = document.createElement('option'); optAll.value='__all__'; optAll.textContent='（すべて）'; sel.appendChild(optAll);
      users.forEach(u=>{ const o=document.createElement('option'); o.value=u.user; o.textContent=`${u.user}（${u.sessions}回）`; sel.appendChild(o); });
      // ① URL ?user=xxx があればそれを優先、②なければ localStorage の最後のユーザ、③どちらもなければ（すべて）
      const paramUser = new URLSearchParams(location.search).get('user');
      const stored = (localStorage.getItem('quiz:lastUser')||'').trim();
      const userSet = new Set(users.map(u=>u.user));
      let defaultUser = '__all__';
      if (paramUser && userSet.has(paramUser)) defaultUser = paramUser;
      else if (stored && userSet.has(stored))  defaultUser = stored;
      sel.value = defaultUser;
      populateResetUsers(users);
      syncResetUserFromFilter();
    }

    function renderSummary(data){
      $('#st-sessions').textContent = fmt(data.totals.sessions);
      $('#st-answered').textContent = fmt(data.totals.answered);
      $('#st-acc').textContent = (data.totals.answered? Math.round(data.totals.correct/data.totals.answered*100):0) + '%';

      const sessBody = $('#tbl-sessions tbody');
      sessBody.innerHTML='';
      const sessions = Array.isArray(data.sessions)? data.sessions.slice(): [];
      const toTs = iso=>{
        if(!iso) return 0;
        const ts = new Date(iso).getTime();
        return Number.isNaN(ts)? 0: ts;
      };
      sessions.sort((a,b)=> toTs(b && (b.endedAt||b.receivedAt)) - toTs(a && (a.endedAt||a.receivedAt)) );
      window.__sessions = sessions;
      sessions.forEach(s=>{
        const startIso = s.startedAt || s.endedAt;
        const endIso = s.endedAt;
        const startTxt = startIso? new Date(startIso).toLocaleString(): '―';
        const endTxt = endIso? new Date(endIso).toLocaleString(): '―';
        const total = Number(s.total ?? 0) || 0;
        const correct = Number(s.correct ?? 0) || 0;
        const acc = total? Math.round((correct/total)*100):0;
        let reviewCell = '<span class="muted">―</span>';
        if((s.mode||'normal') !== 'review'){
          reviewCell = s.reviewDone? '<span class="badge ok">済</span>' : '<span class="badge muted">未</span>';
        }
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${startTxt}</td>`+
                       `<td>${endTxt}</td>`+
                       `<td class="center">${s.setIndex ?? '―'}</td>`+
                       `<td class="center ok">${fmt(correct)}</td>`+
                       `<td class="center">${fmt(total)}</td>`+
                       `<td class="center">${acc}%</td>`+
                       `<td class="center">${reviewCell}</td>`;
        sessBody.appendChild(tr);
      });

      // 単元テーブル
      const tb=$('#tbl-units tbody'); tb.innerHTML='';
      data.byUnit.forEach(u=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${u.unit||'(未設定)'}</td>
                        <td class="center">${fmt(u.answered)}</td>
                        <td class="center ok">${fmt(u.correct)}</td>
                        <td class="center ng">${fmt(u.wrong)}</td>
                        <td class="center">${u.answered? Math.round(u.correct/u.answered*100):0}%</td>`;
        tr.onclick=()=>{ const unitSel=$('#unit'); unitSel.value=u.unit||''; refresh(); };
        tb.appendChild(tr);
      });

      // TOP10
      const top=$('#tbl-top tbody'); top.innerHTML='';
      data.topMissed.slice(0,10).forEach(q=>{
        const tr=document.createElement('tr');
        const acc = q.answered? Math.round((q.answered-q.wrong)/q.answered*100):0;
        const stageCell = q.stage ? `<span class="badge">${q.stage}</span>` : '<span class="muted">--</span>';
        tr.innerHTML = `<td class="center">${fmt(q.wrong)}</td>
                        <td>${q.id||''}</td>
                        <td>${q.jp||''}</td>
                        <td>${q.en||''}</td>
                        <td>${q.unit||''}</td>
                        <td class="center">${stageCell}</td>
                        <td class="center ng">${fmt(q.wrong)} / ${fmt(q.answered)}</td>
                        <td class="center">${acc}%</td>`;
        top.appendChild(tr);
      });

      // 最近の解答
      const recent=$('#tbl-recent tbody'); recent.innerHTML='';
      data.recentAnswers.forEach(r=>{
        const tr=document.createElement('tr');
        const ok = !!r.correct;
        const mark = ok? '○':'×';
        const at = r.at || r.endedAt;
        const dateText = at? new Date(at).toLocaleString(): '―';
        const rankText = (r && typeof r.rank === 'string') ? r.rank : (r && r.rank ? String(r.rank) : '');
        const stageText = (r && typeof r.stage === 'string') ? r.stage : (r && r.stage ? String(r.stage) : '');
        const stageBadge = stageText ? `<span class="badge">${stageText}</span>` : '<span class="muted">--</span>';
        tr.innerHTML = `<td>${dateText}</td>`+
                       `<td>${r.id||''}</td>`+
                       `<td class="center">${rankText||''}</td>`+
                       `<td class="center">${stageBadge}</td>`+
                       `<td class="center ${ok?'ok':'ng'}">${mark}</td>`+
                       `<td>${r.userAnswer||''}</td>`+
                       `<td>${r.en||''}</td>`+
                       `<td>${r.jp||''}</td>`+
                       `<td>${r.unit||''}</td>`+
                       `<td>${r.user||''}</td>`;
        if(!ok){ tr.style.background='rgba(239,68,68,.08)'; }
        recent.appendChild(tr);
      });

      // 問題別正誤
      const qVocab=$('#tbl-words-vocab tbody');
      const qReorder=$('#tbl-words-reorder tbody');
      const qRewrite=$('#tbl-words-rewrite tbody');
      qVocab.innerHTML='';
      qReorder.innerHTML='';
      qRewrite.innerHTML='';
      data.questionStats.forEach(q=>{
        const acc = q.answered? Math.round(q.correct/q.answered*100):0;
        const tr=document.createElement('tr');
        const stageCell = q.stage ? `<span class="badge">${q.stage}</span>` : '<span class="muted">--</span>';
        const dueText = q.nextDueAt ? new Date(q.nextDueAt).toLocaleDateString() : '―';
        const levelText = (q && typeof q.level === 'string' && q.level.trim()) ? q.level : '―';
        tr.innerHTML = `<td>${q.id||''}</td>
                        <td>${q.jp||''}</td>
                        <td>${q.en||''}</td>
                        <td class="center">${levelText}</td>
                        <td class="center ok">${fmt(q.correct)}</td>
                        <td class="center ng">${fmt(q.wrong)}</td>
                        <td class="center">${stageCell}</td>
                        <td class="center">${dueText}</td>
                        <td class="center">${fmt(q.streak||0)}</td>
                        <td class="center">${acc}%</td>`;
        if(q.type==='vocab' || q.type==='vocab-choice') qVocab.appendChild(tr);
        else if(q.type==='rewrite') qRewrite.appendChild(tr);
        else qReorder.appendChild(tr);
      });

      updateResetQuestionList(Array.isArray(data.questionStats)? data.questionStats: []);

      const stageSec = $('#sec-stages');
      const stageGrid = $('#stage-grid');
      const stageDescriptions = {
        'A': '最終正解から14日以上空いた出題でも連続正解したもの。',
        'B': '最終正解から7日以上空いた出題でも連続正解したもの。',
        'C': '最終正解から3日以上空いた出題でも連続正解したもの。',
        'D': '最終正解から2日以上空いた出題で連続正解を達成したもの。',
        'E': '連続正解が3回以上のもの。',
        'F': '未回答、または連続正解が3回以下のもの。'
      };
      stageGrid.innerHTML = '';
      const selectedUser = $('#user').value || '__all__';
      const stageBuckets = data.stageBuckets || {};
      if(selectedUser === '__all__'){
        stageSec.style.display = 'none';
      }else{
        stageSec.style.display = '';
        const entries = Object.entries(stageBuckets);
        if(entries.length === 0){
          const emptyBox = document.createElement('div');
          emptyBox.className = 'stage-col';
          emptyBox.innerHTML = '<h4>ステージ情報<span>データなし</span></h4><div class="stage-scroll"><div class="empty">ステージデータがありません。</div></div>';
          stageGrid.appendChild(emptyBox);
        }else{
          entries.forEach(([stageName, questions])=>{
            const col = document.createElement('div');
            col.className = 'stage-col';
            const header = document.createElement('h4');
            header.innerHTML = `Stage ${stageName}<span>${Array.isArray(questions)? questions.length:0} 件</span>`;
            col.appendChild(header);
            const description = stageDescriptions[stageName];
            if(description){
              const descEl = document.createElement('p');
              descEl.className = 'stage-desc';
              descEl.textContent = description;
              col.appendChild(descEl);
            }
            const scroll = document.createElement('div');
            scroll.className = 'stage-scroll';
            if(!Array.isArray(questions) || questions.length===0){
              scroll.innerHTML = '<div class="empty">該当なし</div>';
            }else{
              const table = document.createElement('table');
              table.innerHTML = '<thead><tr><th>ID</th><th>日本語</th><th>英語</th><th>次回</th><th>単元</th><th>種別</th></tr></thead>';
              const body = document.createElement('tbody');
              questions.forEach(q=>{
                const tr = document.createElement('tr');
                const dueText = q.nextDueAt ? new Date(q.nextDueAt).toLocaleString() : '―';
                const cells = [
                  ['ID', q.id||''],
                  ['日本語', q.jp||''],
                  ['英語', q.en||''],
                  ['次回', dueText],
                  ['単元', q.unit||''],
                  ['種別', q.type||'']
                ];
                tr.innerHTML = cells.map(([label, value])=>`<td data-label="${label}">${value}</td>`).join('');
                body.appendChild(tr);
              });
              table.appendChild(body);
              scroll.appendChild(table);
            }
            col.appendChild(scroll);
            stageGrid.appendChild(col);
          });
        }
      }
      $('#last-updated').textContent = '更新: ' + new Date().toLocaleTimeString();
    }

    function updateDisplay(){
      const show = $('#show').value;
      const secV = $('#sec-vocab');
      const secR = $('#sec-reorder');
      const secW = $('#sec-rewrite');
      const cont = $('#sec-words');
      const sections = [
        { type: 'vocab', el: secV },
        { type: 'reorder', el: secR },
        { type: 'rewrite', el: secW },
      ];
      const validTypes = new Set(sections.map(s=>s.type));
      const visibleTypes = (show==='all' || !validTypes.has(show))
        ? sections.map(s=>s.type)
        : [show];
      sections.forEach(({type, el})=>{
        if(!el) return;
        el.style.display = visibleTypes.includes(type)? '' : 'none';
      });
      if(cont){
        cont.classList.remove('cols-1','cols-2','cols-3');
        const count = sections.filter(s=>visibleTypes.includes(s.type)).length;
        if(count<=1) cont.classList.add('cols-1');
        else if(count===2) cont.classList.add('cols-2');
        else cont.classList.add('cols-3');
      }
    }

    async function refresh(){
      const user = $('#user').value || '__all__';
      const unit = $('#unit').value || '';
      const q = $('#search').value.trim();
      const mode = $('#mode').value || 'normal';
      const show = $('#show').value || 'all';
      const data = await getJSON('/api/admin/summary', {user, unit, q, mode, show});

      // unit セレクタを埋める（保持）
      const unitSel=$('#unit');
      const current = unitSel.value;
      unitSel.innerHTML = '<option value="">（すべて）</option>' + data.byUnit.map(u=>`<option value="${u.unit||''}">${u.unit||'(未設定)'}</option>`).join('');
      unitSel.value = unit || current;

      renderSummary(data);
      updateDisplay();
    }

    async function handleResetSubmit(event){
      event.preventDefault();
      const userSel = $('#reset-user');
      const qInput = $('#reset-question');
      const button = $('#btn-reset');
      if(!userSel || !qInput || !button){
        return;
      }
      const user = (userSel.value || '').trim();
      const qid = (qInput.value || '').trim();
      if(!user){
        setResetMessage('ユーザを選択してください。', 'ng');
        return;
      }
      if(!qid){
        setResetMessage('問題IDを入力してください。', 'ng');
        return;
      }
      if(!window.confirm(`ユーザ「${user}」 / 問題ID「${qid}」のステージ履歴を削除します。よろしいですか？`)){
        setResetMessage('リセットをキャンセルしました。', 'muted');
        return;
      }
      const payload = { user, id: qid };
      button.disabled = true;
      setResetMessage('リセット処理を実行中です…', 'muted');
      try{
        const res = await fetch('/api/admin/reset-progress', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body:JSON.stringify({ ...payload, subject: SUBJECT })
        });
        const data = await res.json().catch(()=>({ ok:false, error:'unexpected response' }));
        if(!res.ok || !data.ok){
          throw new Error(data && data.error ? data.error : `HTTP ${res.status}`);
        }
        await refresh();
        const msg = data.stageRemoved
          ? 'ステージ履歴を削除しました。'
          : '対象のステージ履歴は見つかりませんでした。';
        setResetMessage(msg, data.stageRemoved ? 'ok' : 'muted');
        qInput.value='';
      }catch(err){
        console.error(err);
        setResetMessage(`リセットに失敗しました: ${err.message || err}`, 'ng');
      }finally{
        button.disabled = false;
      }
    }

    async function handleLevelSubmit(event){
      event.preventDefault();
      const qInput = $('#level-question');
      const levelInput = $('#level-value');
      const saveButton = $('#btn-level-save');
      if(!qInput || !levelInput || !saveButton){
        return;
      }
      const qid = (qInput.value || '').trim();
      const levelValue = (levelInput.value || '').trim();
      if(!qid){
        setLevelMessage('問題IDを入力してください。', 'ng');
        return;
      }
      if(!levelValue){
        setLevelMessage('設定するレベルを入力してください。', 'ng');
        return;
      }
      if(!window.confirm(`問題ID「${qid}」のレベルを「${levelValue}」に設定します。よろしいですか？`)){
        setLevelMessage('レベル変更をキャンセルしました。', 'muted');
        return;
      }
      saveButton.disabled = true;
      setLevelMessage('レベルを更新しています…', 'muted');
      try{
        const res = await fetch('/api/admin/question-level', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body:JSON.stringify({ id: qid, level: levelValue, subject: SUBJECT })
        });
        const data = await res.json().catch(()=>({ ok:false, error:'unexpected response' }));
        if(!res.ok || !data.ok){
          throw new Error(data && data.error ? data.error : `HTTP ${res.status}`);
        }
        await refresh();
        const levelText = data.effectiveLevel || levelValue;
        setLevelMessage(`レベルを ${levelText || ''} に更新しました。`, 'ok');
      }catch(err){
        console.error(err);
        setLevelMessage(`レベルの更新に失敗しました: ${err.message || err}`, 'ng');
      }finally{
        saveButton.disabled = false;
      }
    }

    async function handleLevelClear(event){
      event.preventDefault();
      const qInput = $('#level-question');
      const levelInput = $('#level-value');
      const saveButton = $('#btn-level-save');
      const clearButton = $('#btn-level-clear');
      if(!qInput || !clearButton){
        return;
      }
      const qid = (qInput.value || '').trim();
      if(!qid){
        setLevelMessage('問題IDを入力してください。', 'ng');
        return;
      }
      if(!window.confirm(`問題ID「${qid}」のレベル上書きを削除します。よろしいですか？`)){
        setLevelMessage('レベル上書きの削除をキャンセルしました。', 'muted');
        return;
      }
      clearButton.disabled = true;
      if(saveButton) saveButton.disabled = true;
      setLevelMessage('レベル上書きを削除しています…', 'muted');
      try{
        const res = await fetch('/api/admin/question-level', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body:JSON.stringify({ id: qid, level: '', subject: SUBJECT })
        });
        const data = await res.json().catch(()=>({ ok:false, error:'unexpected response' }));
        if(!res.ok || !data.ok){
          throw new Error(data && data.error ? data.error : `HTTP ${res.status}`);
        }
        await refresh();
        const levelText = data.effectiveLevel || '未設定';
        setLevelMessage(`レベル上書きを削除しました。（現在: ${levelText || '未設定'}）`, 'ok');
        if(levelInput) levelInput.value = '';
      }catch(err){
        console.error(err);
        setLevelMessage(`レベル上書きの削除に失敗しました: ${err.message || err}`, 'ng');
      }finally{
        clearButton.disabled = false;
        if(saveButton) saveButton.disabled = false;
      }
    }

    async function main(){
      await loadUsers();
      await refresh();
      $('#user').onchange=()=>{ setResetMessage(''); setLevelMessage(''); setTimeout(syncResetUserFromFilter, 0); refresh(); };
      $('#unit').onchange=()=>{ setResetMessage(''); setLevelMessage(''); refresh(); };
      $('#mode').onchange=()=>{ setResetMessage(''); setLevelMessage(''); refresh(); };
      $('#search').oninput=()=>{ setResetMessage(''); setLevelMessage(''); clearTimeout(window.__t); window.__t=setTimeout(refresh, 400); };
      $('#show').onchange=()=>{ setResetMessage(''); setLevelMessage(''); refresh(); };
      const formReset = $('#form-reset');
      if(formReset){ formReset.addEventListener('submit', handleResetSubmit); }
      const formLevel = $('#form-level');
      if(formLevel){ formLevel.addEventListener('submit', handleLevelSubmit); }
      const clearButton = $('#btn-level-clear');
      if(clearButton){ clearButton.addEventListener('click', handleLevelClear); }
    }

    main().catch(e=>{ alert('読み込みに失敗しました: '+e.message); console.error(e); });
  </script>
</body>
</html>
