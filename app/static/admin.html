<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>成績ダッシュボード｜並べ替えクイズ</title>
  <style>
    :root{ --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --border:#1f2937; --accent:#3b82f6; --warn:#ef4444; --ok:#22c55e }
    *{ box-sizing:border-box }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif }
    header{ position:sticky; top:0; background:rgba(17,24,39,.9); backdrop-filter:saturate(150%) blur(6px); border-bottom:1px solid var(--border); z-index:10 }
    .container{ max-width:1100px; margin:0 auto; padding:16px }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
    .pill{ display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; border:1px solid #334155; background:#0b1220; color:#cbd5e1; font-size:12px }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px; margin:16px 0 }
    .grid{ display:grid; gap:12px }
    .grid.cols-3{ grid-template-columns: repeat(3,1fr) }
    .grid.cols-2{ grid-template-columns: repeat(2,1fr) }
    .stat{ background:#0b1220; border:1px solid #334155; border-radius:12px; padding:12px }
    .muted{ color:var(--muted) }
    table{ width:100%; border-collapse: collapse; }
    th,td{ padding:8px 10px; border-bottom:1px solid #334155; vertical-align:top }
    th{ text-align:left; color:#cbd5e1; background:#0b1220; position:sticky; top:0 }
    tr:hover td{ background:#0b1220 }
    .badge{ padding:2px 8px; border-radius:999px; border:1px solid #334155; font-size:12px }
    .ok{ color:var(--ok) } .ng{ color:var(--warn) }
    select,input{ background:#0b1220; color:#e5e7eb; border:1px solid #334155; border-radius:10px; padding:8px 10px }
    .right{ margin-left:auto }
    .center{ text-align:center }
  </style>
</head>
<body>
  <header>
    <div class="container row">
      <div>
        <h2 style="margin:0">成績ダッシュボード</h2>
        <div class="muted" style="font-size:12px">ユーザ別集計／単元別／よく間違える問題／最近の解答</div>
      </div>
      <a href="/" class="pill right">⬅ クイズへ戻る</a>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <div class="row">
        <label class="row" style="gap:6px">
          <span class="muted">ユーザ</span>
          <select id="user"></select>
        </label>
        <label class="row" style="gap:6px">
          <span class="muted">単元</span>
          <select id="unit"><option value="">（すべて）</option></select>
        </label>
        <label class="row" style="gap:6px">
          <span class="muted">モード</span>
          <select id="mode"><option value="normal">通常</option><option value="review">復習</option></select>
        </label>
        <input id="search" placeholder="問題検索（日本語/英語/ID）" style="min-width:220px" />
        <span class="pill right" id="last-updated">更新: --</span>
      </div>
    </section>

    <section class="grid cols-3">
      <div class="stat"><div class="muted">学習回数</div><div id="st-sessions" style="font-size:24px;font-weight:800">0</div></div>
      <div class="stat"><div class="muted">解答数</div><div id="st-answered" style="font-size:24px;font-weight:800">0</div></div>
      <div class="stat"><div class="muted">平均正答率</div><div id="st-acc" style="font-size:24px;font-weight:800">0%</div></div>
    </section>

    <section class="card">
      <h3 style="margin:0 0 8px">単元別（Unit）</h3>
      <div style="max-height:260px; overflow:auto">
        <table id="tbl-units"><thead><tr><th>単元</th><th class="center">解答</th><th class="center">正答</th><th class="center">誤答</th><th class="center">正答率</th></tr></thead><tbody></tbody></table>
      </div>
    </section>

    <section class="grid cols-2">
      <div class="card">
        <h3 style="margin:0 0 8px">よく間違える問題（TOP10）</h3>
        <div style="max-height:340px; overflow:auto">
          <table id="tbl-top"><thead><tr><th style="width:60px">回数</th><th>ID</th><th>日本語</th><th>英語</th><th>単元</th><th class="center">誤答/解答</th><th class="center">正答率</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
      <div class="card">
        <h3 style="margin:0 0 8px">最近の解答（最大100件）</h3>
        <div style="max-height:340px; overflow:auto">
          <table id="tbl-recent"><thead><tr><th>日時</th><th>ID</th><th>結果</th><th>あなたの解答</th><th>正解</th><th>単元</th><th>ユーザ</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </section>

    <section class="card">
      <h3 style="margin:0 0 8px">単語別正誤</h3>
      <div style="max-height:340px; overflow:auto">
        <table id="tbl-words"><thead><tr><th>ID</th><th>日本語</th><th>英語</th><th class="center">正答</th><th class="center">誤答</th><th class="center">連続正解</th><th class="center">正答率</th></tr></thead><tbody></tbody></table>
      </div>
    </section>
  </main>

  <script>
    const $ = s=>document.querySelector(s);
    const $$ = s=>Array.from(document.querySelectorAll(s));
    const fmt = n=> new Intl.NumberFormat().format(n);
    const pct = x=> (Math.round(x*1000)/10).toFixed(1)+"%";
    const qs  = (obj)=> Object.entries(obj).map(([k,v])=> v!==undefined && v!==''? `${encodeURIComponent(k)}=${encodeURIComponent(v)}`:'' ).filter(Boolean).join('&');

    async function getJSON(path, params={}){
      const url = params && Object.keys(params).length? `${path}?${qs(params)}` : path;
      const res = await fetch(url, {cache:'no-store'});
      if(!res.ok) throw new Error(`fetch ${path} ${res.status}`);
      return await res.json();
    }

    async function loadUsers(){
      const users = await getJSON('/api/admin/users');
      const sel = $('#user'); sel.innerHTML='';
      const optAll = document.createElement('option'); optAll.value='__all__'; optAll.textContent='（すべて）'; sel.appendChild(optAll);
      users.forEach(u=>{ const o=document.createElement('option'); o.value=u.user; o.textContent=`${u.user}（${u.sessions}回）`; sel.appendChild(o); });
      // ① URL ?user=xxx があればそれを優先、②なければ localStorage の最後のユーザ、③どちらもなければ（すべて）
      const paramUser = new URLSearchParams(location.search).get('user');
      const stored = (localStorage.getItem('quiz:lastUser')||'').trim();
      const userSet = new Set(users.map(u=>u.user));
      let defaultUser = '__all__';
      if (paramUser && userSet.has(paramUser)) defaultUser = paramUser;
      else if (stored && userSet.has(stored))  defaultUser = stored;
      sel.value = defaultUser;
    }

    function renderSummary(data){
      $('#st-sessions').textContent = fmt(data.totals.sessions);
      $('#st-answered').textContent = fmt(data.totals.answered);
      $('#st-acc').textContent = (data.totals.answered? Math.round(data.totals.correct/data.totals.answered*100):0) + '%';

      // 単元テーブル
      const tb=$('#tbl-units tbody'); tb.innerHTML='';
      data.byUnit.forEach(u=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${u.unit||'(未設定)'}</td>
                        <td class="center">${fmt(u.answered)}</td>
                        <td class="center ok">${fmt(u.correct)}</td>
                        <td class="center ng">${fmt(u.wrong)}</td>
                        <td class="center">${u.answered? Math.round(u.correct/u.answered*100):0}%</td>`;
        tr.onclick=()=>{ const unitSel=$('#unit'); unitSel.value=u.unit||''; refresh(); };
        tb.appendChild(tr);
      });

      // TOP10
      const top=$('#tbl-top tbody'); top.innerHTML='';
      data.topMissed.slice(0,10).forEach(q=>{
        const tr=document.createElement('tr');
        const acc = q.answered? Math.round((q.answered-q.wrong)/q.answered*100):0;
        tr.innerHTML = `<td class="center">${fmt(q.wrong)}</td>
                        <td>${q.id||''}</td>
                        <td>${q.jp||''}</td>
                        <td>${q.en||''}</td>
                        <td>${q.unit||''}</td>
                        <td class="center ng">${fmt(q.wrong)} / ${fmt(q.answered)}</td>
                        <td class="center">${acc}%</td>`;
        top.appendChild(tr);
      });

      // 最近の解答
      const recent=$('#tbl-recent tbody'); recent.innerHTML='';
      data.recentAnswers.forEach(r=>{
        const tr=document.createElement('tr');
        const ok = r.correct; const mark = ok? '○':'×';
        tr.innerHTML = `<td>${new Date(r.at||r.endedAt).toLocaleString()}</td>
                        <td>${r.id||''}</td>
                        <td class="center ${ok?'ok':'ng'}">${mark}</td>
                        <td>${r.userAnswer||''}</td>
                        <td>${r.en||''}</td>
                        <td>${r.unit||''}</td>
                        <td>${r.user||''}</td>`;
        if(!ok){ tr.style.background='rgba(239,68,68,.08)'; }
        recent.appendChild(tr);
      });

      // 単語別正誤
      const qstat=$('#tbl-words tbody'); qstat.innerHTML='';
      data.questionStats.forEach(q=>{
        const acc = q.answered? Math.round(q.correct/q.answered*100):0;
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${q.id||''}</td>
                        <td>${q.jp||''}</td>
                        <td>${q.en||''}</td>
                        <td class="center ok">${fmt(q.correct)}</td>
                        <td class="center ng">${fmt(q.wrong)}</td>
                        <td class="center">${fmt(q.streak||0)}</td>
                        <td class="center">${acc}%</td>`;
        qstat.appendChild(tr);
      });
      $('#last-updated').textContent = '更新: ' + new Date().toLocaleTimeString();
    }

    async function refresh(){
      const user = $('#user').value || '__all__';
      const unit = $('#unit').value || '';
      const q = $('#search').value.trim();
      const mode = $('#mode').value || 'normal';
      const data = await getJSON('/api/admin/summary', {user, unit, q, mode});

      // unit セレクタを埋める（保持）
      const unitSel=$('#unit');
      const current = unitSel.value;
      unitSel.innerHTML = '<option value="">（すべて）</option>' + data.byUnit.map(u=>`<option value="${u.unit||''}">${u.unit||'(未設定)'}</option>`).join('');
      unitSel.value = unit || current;

      renderSummary(data);
    }

    async function main(){
      await loadUsers();
      await refresh();
      $('#user').onchange=refresh; $('#unit').onchange=refresh; $('#mode').onchange=refresh;
      $('#search').oninput=()=>{ clearTimeout(window.__t); window.__t=setTimeout(refresh, 400); };
    }

    main().catch(e=>{ alert('読み込みに失敗しました: '+e.message); console.error(e); });
  </script>
</body>
</html>
