<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>成績ダッシュボード｜並べ替えクイズ</title>
  <style>
    :root{ --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --border:#1f2937; --accent:#3b82f6; --warn:#ef4444; --ok:#22c55e }
    *{ box-sizing:border-box }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif }
    header{ position:sticky; top:0; background:rgba(17,24,39,.9); backdrop-filter:saturate(150%) blur(6px); border-bottom:1px solid var(--border); z-index:10 }
    .container{ width:min(1400px, calc(100vw - 48px)); margin:0 auto; padding:16px }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
    .row.filters{ align-items:flex-end }
    .pill{ display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; border:1px solid #334155; background:#0b1220; color:#cbd5e1; font-size:12px }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px; margin:16px 0 }
    .grid{ display:grid; gap:12px }
    .grid.cols-3{ grid-template-columns: repeat(3,1fr) }
    .grid.cols-2{ grid-template-columns: repeat(2,1fr) }
    .grid.cols-1{ grid-template-columns: 1fr }
    .stat{ background:#0b1220; border:1px solid #334155; border-radius:12px; padding:12px }
    .muted{ color:var(--muted) }
    table{ width:100%; border-collapse: collapse; }
    th,td{ padding:8px 10px; border-bottom:1px solid #334155; vertical-align:top }
    th{ text-align:left; color:#cbd5e1; background:#0b1220; position:sticky; top:0 }
    tr:hover td{ background:#0b1220 }
    .badge{ padding:2px 8px; border-radius:999px; border:1px solid #334155; font-size:12px }
    .ok{ color:var(--ok) } .ng{ color:var(--warn) }
    select,input{ background:#0b1220; color:#e5e7eb; border:1px solid #334155; border-radius:10px; padding:8px 10px }
    .right{ margin-left:auto }
    .center{ text-align:center }
    .stage-grid{ display:grid; gap:12px; grid-template-columns:repeat(2,minmax(0,1fr)); align-items:start; }
    .stage-col{ background:#0b1220; border:1px solid #334155; border-radius:12px; padding:12px; display:flex; flex-direction:column; max-height:340px }
    .stage-col h4{ margin:0 0 8px; font-size:14px; display:flex; align-items:center; justify-content:space-between }
    .stage-col h4 span{ font-size:11px; color:var(--muted) }
    .stage-col .stage-scroll{ overflow:auto; flex:1 }
    .stage-col table{ font-size:12px; width:100%; }
    .stage-col th, .stage-col td{ padding:6px 8px }
    .stage-col .empty{ color:var(--muted); font-size:12px; padding:4px 0 }
    @media (max-width: 1024px){
      .grid.cols-3{ grid-template-columns: repeat(2,minmax(0,1fr)); }
    }

    @media (max-width: 768px){
      .container{ width:calc(100vw - 32px); padding:12px }
      header .container{ padding:12px }
      .row.filters{ flex-direction:column; align-items:stretch; gap:12px }
      .row.filters label,
      .row.filters input,
      .row.filters select,
      .row.filters .pill{ width:100% }
      .row.filters .pill{ justify-content:center; margin-left:0 }
      .grid.cols-3,
      .grid.cols-2{ grid-template-columns:1fr }
      .stage-grid{ grid-template-columns:1fr; }
      .stage-col{ max-height:none; }
      .stage-col .stage-scroll{ overflow:visible; max-height:none; }
    }

    @media (max-width: 640px){
      .stage-col table{ border:0; }
      .stage-col thead{ display:none; }
      .stage-col tbody{ display:grid; gap:10px; }
      .stage-col tr{ display:grid; grid-template-columns:minmax(0,1fr); gap:6px; padding:10px; border:1px solid #334155; border-radius:10px; background:#101726; }
      .stage-col td{ border:none; padding:0; display:block; }
      .stage-col td::before{ content:attr(data-label); color:var(--muted); font-weight:600; font-size:11px; display:block; margin-bottom:2px; }
    }

    @media (max-width: 480px){
      body{ font-size:14px }
      h2{ font-size:20px }
      .stage-grid{ grid-template-columns:1fr }
    }
  </style>
</head>
<body>
  <header>
    <div class="container row">
      <div>
        <h2 style="margin:0">成績ダッシュボード</h2>
        <div class="muted" style="font-size:12px">ユーザ別集計／単元別／よく間違える問題／最近の解答</div>
      </div>
      <a href="/" class="pill right">⬅ クイズへ戻る</a>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <div class="row filters">
        <label class="row" style="gap:6px">
          <span class="muted">ユーザ</span>
          <select id="user"></select>
        </label>
        <label class="row" style="gap:6px">
          <span class="muted">単元</span>
          <select id="unit"><option value="">（すべて）</option></select>
        </label>
        <label class="row" style="gap:6px">
          <span class="muted">モード</span>
          <select id="mode"><option value="normal">通常</option><option value="review">復習</option></select>
        </label>
        <label class="row" style="gap:6px">
          <span class="muted">表示</span>
          <select id="show"><option value="all">両方</option><option value="vocab">単語問題</option><option value="reorder">並べ替え問題</option></select>
        </label>
        <input id="search" placeholder="問題検索（日本語/英語/ID）" style="min-width:220px" />
        <span class="pill right" id="last-updated">更新: --</span>
      </div>
    </section>

    <section class="grid cols-3">
      <div class="stat"><div class="muted">学習回数</div><div id="st-sessions" style="font-size:24px;font-weight:800">0</div></div>
      <div class="stat"><div class="muted">解答数</div><div id="st-answered" style="font-size:24px;font-weight:800">0</div></div>
      <div class="stat"><div class="muted">平均正答率</div><div id="st-acc" style="font-size:24px;font-weight:800">0%</div></div>
    </section>

    <section class="card">
      <h3 style="margin:0 0 8px">テスト一覧</h3>
      <div style="max-height:340px; overflow:auto">
        <table id="tbl-sessions"><thead><tr><th>開始</th><th>終了</th><th class="center">セット</th><th class="center">正解</th><th class="center">出題</th><th class="center">正答率</th><th class="center">復習</th></tr></thead><tbody></tbody></table>
      </div>
    </section>

    <section class="card">
      <h3 style="margin:0 0 8px">単元別（Unit）</h3>
      <div style="max-height:260px; overflow:auto">
        <table id="tbl-units"><thead><tr><th>単元</th><th class="center">解答</th><th class="center">正答</th><th class="center">誤答</th><th class="center">正答率</th></tr></thead><tbody></tbody></table>
      </div>
    </section>

    <section class="card">
      <h3 style="margin:0 0 8px">最近の解答（最大100件）</h3>
      <div style="max-height:340px; overflow:auto">
        <table id="tbl-recent"><thead><tr><th>日時</th><th>ID</th><th class="center">ランク</th><th class="center">結果</th><th>ユーザ解答</th><th>正解（英語）</th><th>正解（日本語）</th><th>単元</th><th>ユーザ</th></tr></thead><tbody></tbody></table>
      </div>
    </section>

    <section class="card">
      <h3 style="margin:0 0 8px">よく間違える問題（TOP10）</h3>
      <div style="max-height:340px; overflow:auto">
        <table id="tbl-top"><thead><tr><th style="width:60px">回数</th><th>ID</th><th>日本語</th><th>英語</th><th>単元</th><th class="center">誤答/解答</th><th class="center">正答率</th></tr></thead><tbody></tbody></table>
      </div>
    </section>

    <section class="card" id="sec-stages" style="display:none">
      <h3 style="margin:0 0 8px">ステージ進捗</h3>
      <div class="stage-grid" id="stage-grid"></div>
    </section>

    <section class="grid cols-2" id="sec-words">
      <div class="card" id="sec-vocab">
        <h3 style="margin:0 0 8px">単語問題</h3>
        <div style="max-height:340px; overflow:auto">
          <table id="tbl-words-vocab"><thead><tr><th>ID</th><th>日本語</th><th>英語</th><th class="center">正答</th><th class="center">誤答</th><th class="center">ランク</th><th class="center">次回</th><th class="center">連続正解</th><th class="center">正答率</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
      <div class="card" id="sec-reorder">
        <h3 style="margin:0 0 8px">並べ替え問題</h3>
        <div style="max-height:340px; overflow:auto">
          <table id="tbl-words-reorder"><thead><tr><th>ID</th><th>日本語</th><th>英語</th><th class="center">正答</th><th class="center">誤答</th><th class="center">ランク</th><th class="center">次回</th><th class="center">連続正解</th><th class="center">正答率</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </section>
  </main>

  <script>
    const SUBJECT = 'english';
    const $ = s=>document.querySelector(s);
    const $$ = s=>Array.from(document.querySelectorAll(s));
    const fmt = n=> new Intl.NumberFormat().format(n);
    const pct = x=> (Math.round(x*1000)/10).toFixed(1)+"%";
    const qs  = (obj)=> Object.entries(obj).map(([k,v])=> v!==undefined && v!==''? `${encodeURIComponent(k)}=${encodeURIComponent(v)}`:'' ).filter(Boolean).join('&');

    async function getJSON(path, params={}){
      const merged = { subject: SUBJECT, ...params };
      const url = merged && Object.keys(merged).length? `${path}?${qs(merged)}` : path;
      const res = await fetch(url, {cache:'no-store'});
      if(!res.ok) throw new Error(`fetch ${path} ${res.status}`);
      return await res.json();
    }

    async function loadUsers(){
      const users = await getJSON('/api/admin/users');
      const sel = $('#user'); sel.innerHTML='';
      const optAll = document.createElement('option'); optAll.value='__all__'; optAll.textContent='（すべて）'; sel.appendChild(optAll);
      users.forEach(u=>{ const o=document.createElement('option'); o.value=u.user; o.textContent=`${u.user}（${u.sessions}回）`; sel.appendChild(o); });
      // ① URL ?user=xxx があればそれを優先、②なければ localStorage の最後のユーザ、③どちらもなければ（すべて）
      const paramUser = new URLSearchParams(location.search).get('user');
      const stored = (localStorage.getItem('quiz:lastUser')||'').trim();
      const userSet = new Set(users.map(u=>u.user));
      let defaultUser = '__all__';
      if (paramUser && userSet.has(paramUser)) defaultUser = paramUser;
      else if (stored && userSet.has(stored))  defaultUser = stored;
      sel.value = defaultUser;
    }

    function renderSummary(data){
      $('#st-sessions').textContent = fmt(data.totals.sessions);
      $('#st-answered').textContent = fmt(data.totals.answered);
      $('#st-acc').textContent = (data.totals.answered? Math.round(data.totals.correct/data.totals.answered*100):0) + '%';

      const sessBody = $('#tbl-sessions tbody');
      sessBody.innerHTML='';
      const sessions = Array.isArray(data.sessions)? data.sessions.slice(): [];
      const toTs = iso=>{
        if(!iso) return 0;
        const ts = new Date(iso).getTime();
        return Number.isNaN(ts)? 0: ts;
      };
      sessions.sort((a,b)=> toTs(b && (b.endedAt||b.receivedAt)) - toTs(a && (a.endedAt||a.receivedAt)) );
      window.__sessions = sessions;
      sessions.forEach(s=>{
        const startIso = s.startedAt || s.endedAt;
        const endIso = s.endedAt;
        const startTxt = startIso? new Date(startIso).toLocaleString(): '―';
        const endTxt = endIso? new Date(endIso).toLocaleString(): '―';
        const total = Number(s.total ?? 0) || 0;
        const correct = Number(s.correct ?? 0) || 0;
        const acc = total? Math.round((correct/total)*100):0;
        let reviewCell = '<span class="muted">―</span>';
        if((s.mode||'normal') !== 'review'){
          reviewCell = s.reviewDone? '<span class="badge ok">済</span>' : '<span class="badge muted">未</span>';
        }
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${startTxt}</td>`+
                       `<td>${endTxt}</td>`+
                       `<td class="center">${s.setIndex ?? '―'}</td>`+
                       `<td class="center ok">${fmt(correct)}</td>`+
                       `<td class="center">${fmt(total)}</td>`+
                       `<td class="center">${acc}%</td>`+
                       `<td class="center">${reviewCell}</td>`;
        sessBody.appendChild(tr);
      });

      // 単元テーブル
      const tb=$('#tbl-units tbody'); tb.innerHTML='';
      data.byUnit.forEach(u=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${u.unit||'(未設定)'}</td>
                        <td class="center">${fmt(u.answered)}</td>
                        <td class="center ok">${fmt(u.correct)}</td>
                        <td class="center ng">${fmt(u.wrong)}</td>
                        <td class="center">${u.answered? Math.round(u.correct/u.answered*100):0}%</td>`;
        tr.onclick=()=>{ const unitSel=$('#unit'); unitSel.value=u.unit||''; refresh(); };
        tb.appendChild(tr);
      });

      // TOP10
      const top=$('#tbl-top tbody'); top.innerHTML='';
      data.topMissed.slice(0,10).forEach(q=>{
        const tr=document.createElement('tr');
        const acc = q.answered? Math.round((q.answered-q.wrong)/q.answered*100):0;
        tr.innerHTML = `<td class="center">${fmt(q.wrong)}</td>
                        <td>${q.id||''}</td>
                        <td>${q.jp||''}</td>
                        <td>${q.en||''}</td>
                        <td>${q.unit||''}</td>
                        <td class="center ng">${fmt(q.wrong)} / ${fmt(q.answered)}</td>
                        <td class="center">${acc}%</td>`;
        top.appendChild(tr);
      });

      // 最近の解答
      const recent=$('#tbl-recent tbody'); recent.innerHTML='';
      data.recentAnswers.forEach(r=>{
        const tr=document.createElement('tr');
        const ok = !!r.correct;
        const mark = ok? '○':'×';
        const at = r.at || r.endedAt;
        const dateText = at? new Date(at).toLocaleString(): '―';
        const rankText = (r && typeof r.rank === 'string') ? r.rank : (r && r.rank ? String(r.rank) : '');
        tr.innerHTML = `<td>${dateText}</td>`+
                       `<td>${r.id||''}</td>`+
                       `<td class="center">${rankText||''}</td>`+
                       `<td class="center ${ok?'ok':'ng'}">${mark}</td>`+
                       `<td>${r.userAnswer||''}</td>`+
                       `<td>${r.en||''}</td>`+
                       `<td>${r.jp||''}</td>`+
                       `<td>${r.unit||''}</td>`+
                       `<td>${r.user||''}</td>`;
        if(!ok){ tr.style.background='rgba(239,68,68,.08)'; }
        recent.appendChild(tr);
      });

      // 問題別正誤
      const qVocab=$('#tbl-words-vocab tbody');
      const qReorder=$('#tbl-words-reorder tbody');
      qVocab.innerHTML='';
      qReorder.innerHTML='';
      data.questionStats.forEach(q=>{
        const acc = q.answered? Math.round(q.correct/q.answered*100):0;
        const tr=document.createElement('tr');
        const stageCell = q.stage ? `<span class="badge">${q.stage}</span>` : '<span class="muted">--</span>';
        const dueText = q.nextDueAt ? new Date(q.nextDueAt).toLocaleDateString() : '―';
        tr.innerHTML = `<td>${q.id||''}</td>
                        <td>${q.jp||''}</td>
                        <td>${q.en||''}</td>
                        <td class="center ok">${fmt(q.correct)}</td>
                        <td class="center ng">${fmt(q.wrong)}</td>
                        <td class="center">${stageCell}</td>
                        <td class="center">${dueText}</td>
                        <td class="center">${fmt(q.streak||0)}</td>
                        <td class="center">${acc}%</td>`;
        if(q.type==='vocab') qVocab.appendChild(tr); else qReorder.appendChild(tr);
      });

      const stageSec = $('#sec-stages');
      const stageGrid = $('#stage-grid');
      stageGrid.innerHTML = '';
      const selectedUser = $('#user').value || '__all__';
      const stageBuckets = data.stageBuckets || {};
      if(selectedUser === '__all__'){
        stageSec.style.display = 'none';
      }else{
        stageSec.style.display = '';
        const entries = Object.entries(stageBuckets);
        if(entries.length === 0){
          const emptyBox = document.createElement('div');
          emptyBox.className = 'stage-col';
          emptyBox.innerHTML = '<h4>ステージ情報<span>データなし</span></h4><div class="stage-scroll"><div class="empty">ステージデータがありません。</div></div>';
          stageGrid.appendChild(emptyBox);
        }else{
          entries.forEach(([stageName, questions])=>{
            const col = document.createElement('div');
            col.className = 'stage-col';
            const header = document.createElement('h4');
            header.innerHTML = `Stage ${stageName}<span>${Array.isArray(questions)? questions.length:0} 件</span>`;
            col.appendChild(header);
            const scroll = document.createElement('div');
            scroll.className = 'stage-scroll';
            if(!Array.isArray(questions) || questions.length===0){
              scroll.innerHTML = '<div class="empty">該当なし</div>';
            }else{
              const table = document.createElement('table');
              table.innerHTML = '<thead><tr><th>ID</th><th>日本語</th><th>英語</th><th>次回</th><th>単元</th><th>種別</th></tr></thead>';
              const body = document.createElement('tbody');
              questions.forEach(q=>{
                const tr = document.createElement('tr');
                const dueText = q.nextDueAt ? new Date(q.nextDueAt).toLocaleString() : '―';
                const cells = [
                  ['ID', q.id||''],
                  ['日本語', q.jp||''],
                  ['英語', q.en||''],
                  ['次回', dueText],
                  ['単元', q.unit||''],
                  ['種別', q.type||'']
                ];
                tr.innerHTML = cells.map(([label, value])=>`<td data-label="${label}">${value}</td>`).join('');
                body.appendChild(tr);
              });
              table.appendChild(body);
              scroll.appendChild(table);
            }
            col.appendChild(scroll);
            stageGrid.appendChild(col);
          });
        }
      }
      $('#last-updated').textContent = '更新: ' + new Date().toLocaleTimeString();
    }

    function updateDisplay(){
      const show = $('#show').value;
      const secV = $('#sec-vocab');
      const secR = $('#sec-reorder');
      const cont = $('#sec-words');
      if(show==='vocab'){
        secV.style.display='';
        secR.style.display='none';
        cont.classList.remove('cols-2');
        cont.classList.add('cols-1');
      }else if(show==='reorder'){
        secV.style.display='none';
        secR.style.display='';
        cont.classList.remove('cols-2');
        cont.classList.add('cols-1');
      }else{
        secV.style.display='';
        secR.style.display='';
        cont.classList.remove('cols-1');
        cont.classList.add('cols-2');
      }
    }

    async function refresh(){
      const user = $('#user').value || '__all__';
      const unit = $('#unit').value || '';
      const q = $('#search').value.trim();
      const mode = $('#mode').value || 'normal';
      const show = $('#show').value || 'all';
      const data = await getJSON('/api/admin/summary', {user, unit, q, mode, show});

      // unit セレクタを埋める（保持）
      const unitSel=$('#unit');
      const current = unitSel.value;
      unitSel.innerHTML = '<option value="">（すべて）</option>' + data.byUnit.map(u=>`<option value="${u.unit||''}">${u.unit||'(未設定)'}</option>`).join('');
      unitSel.value = unit || current;

      renderSummary(data);
      updateDisplay();
    }

    async function main(){
      await loadUsers();
      await refresh();
      $('#user').onchange=refresh; $('#unit').onchange=refresh; $('#mode').onchange=refresh;
      $('#search').oninput=()=>{ clearTimeout(window.__t); window.__t=setTimeout(refresh, 400); };
      $('#show').onchange=refresh;
    }

    main().catch(e=>{ alert('読み込みに失敗しました: '+e.message); console.error(e); });
  </script>
</body>
</html>
