<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>数学演習モード</title>
  <style>
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;margin:0;background:#0f172a;color:#e5e7eb;}
    main{max-width:760px;margin:0 auto;padding:24px;}
    h1{margin-top:0;}
    .card{background:#111827;border:1px solid #1f2937;border-radius:16px;padding:20px;margin-bottom:16px;}
    button{background:#2563eb;border:1px solid #2563eb;border-radius:10px;color:#fff;padding:10px 18px;font-size:16px;cursor:pointer;}
    button:disabled{opacity:.5;cursor:not-allowed;}
    input,select{width:100%;padding:12px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e5e7eb;font-size:16px;}
    .field-stack{display:flex;flex-direction:column;gap:12px;margin-top:16px;}
    .field-row{display:flex;flex-direction:row;align-items:center;gap:12px;flex-wrap:wrap;}
    .field-label{font-size:14px;color:#94a3b8;}
    .field-row input{width:8ch;flex:0 0 auto;padding:8px 10px;}
    .field-unit{font-size:14px;color:#94a3b8;}
    #feedback{margin-top:12px;min-height:2.2em;}
    .muted{color:#94a3b8;}
    .ok{color:#22c55e;}
    .ng{color:#ef4444;}
    .question-header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;}
    .badge{display:inline-flex;align-items:center;justify-content:center;padding:4px 10px;border-radius:9999px;font-size:12px;font-weight:600;letter-spacing:.05em;text-transform:uppercase;}
    .badge-normal{background:rgba(37,99,235,.15);color:#93c5fd;border:1px solid rgba(59,130,246,.4);}
    .badge-hard{background:rgba(236,72,153,.15);color:#f9a8d4;border:1px solid rgba(244,114,182,.4);}
    .status-text{font-size:14px;}
    .status-success{color:#4ade80;}
    .status-error{color:#f87171;}
    .field-note{font-size:14px;color:#94a3b8;margin:0;}
    a.link{color:#93c5fd;text-decoration:none;}
    a.link:hover{text-decoration:underline;}
  </style>
</head>
<body>
  <main>
    <div class="card" id="setup-card">
      <h1>数学演習モード</h1>
      <p class="muted">出題レベルを選んで問題に挑戦し、表示された解答欄に入力してから採点してください。複数の欄が表示された場合はそれぞれの欄に1つずつ値を入力してください。</p>
      <div class="field-stack">
        <label class="field-label" for="difficulty-select">出題レベル</label>
        <select id="difficulty-select">
          <option value="normal">標準</option>
          <option value="hard">難問</option>
        </select>
        <p class="field-note">難問を選ぶと文章題など発展的な問題のみが出題されます。</p>
      </div>
      <div class="field-stack" style="margin-top:16px">
        <button id="btn-start" disabled>問題を読み込んでいます…</button>
        <p class="field-note" id="start-note">問題の読み込みが完了したら演習を開始できます。</p>
      </div>
      <p class="field-note" style="margin-top:16px"><a class="link" href="/math-results.html">提出履歴を確認する</a></p>
    </div>
    <div class="card" id="quiz" style="display:none">
      <div style="display:flex;justify-content:flex-end;margin-bottom:12px">
        <button id="btn-change-settings" style="background:#1e293b;border-color:#1e293b;color:#cbd5e1">⚙️ 出題条件を変更</button>
      </div>
      <div class="question-header">
        <div id="question" style="font-size:18px;font-weight:600"></div>
        <span id="difficulty-badge" class="badge badge-normal">標準</span>
      </div>
      <div id="answer-inputs" class="field-stack"></div>
      <div style="display:flex;gap:12px;margin-top:16px;flex-wrap:wrap">
        <button id="btn-check">答え合わせ</button>
        <button id="btn-next" disabled>次の問題 ▶</button>
      </div>
      <div id="feedback" class="muted"></div>
      <div id="save-status" class="status-text muted" aria-live="polite" style="margin-top:8px;min-height:1.4em"></div>
    </div>
    <div class="card" id="loading">読み込み中…</div>
    <div class="card" id="error" style="display:none;color:#ef4444"></div>
  </main>
  <script>
    const SUBJECT = 'math';
    const QUESTIONS_URL = "/data/math/questions.json";
    const RESULT_ENDPOINT = '/api/results';
    const state = {
      allQuestions: [],
      questions: [],
      index: 0,
      graded: false,
      inputs: [],
      fieldSpecs: [],
      sessionId: null,
      attempt: 0,
      difficulty: 'normal',
      started: false,
    };

    function $(sel){ return document.querySelector(sel); }

    const difficultySelect = $('#difficulty-select');
    const difficultyBadge = $('#difficulty-badge');
    const startButton = $('#btn-start');
    const startNote = $('#start-note');
    const setupCard = $('#setup-card');
    const quizCard = $('#quiz');
    const loadingCard = $('#loading');
    const errorCard = $('#error');
    const saveStatusEl = $('#save-status');
    const changeSettingsButton = $('#btn-change-settings');

    function setSaveStatus(message, status = 'muted'){
      if(!saveStatusEl) return;
      const classes = ['status-text'];
      if(status === 'success'){
        classes.push('status-success');
      } else if(status === 'error'){
        classes.push('status-error');
      } else {
        classes.push('muted');
      }
      saveStatusEl.className = classes.join(' ');
      saveStatusEl.textContent = message || '';
    }

    function normalizeDifficulty(value){
      const text = (value == null ? '' : String(value)).toLowerCase();
      return text === 'hard' ? 'hard' : 'normal';
    }

    function labelForDifficulty(level){
      return normalizeDifficulty(level) === 'hard' ? '難問' : '標準';
    }

    function updateDifficultyBadge(level){
      if(!difficultyBadge) return;
      const normalized = normalizeDifficulty(level);
      difficultyBadge.textContent = labelForDifficulty(normalized);
      difficultyBadge.className = `badge ${normalized === 'hard' ? 'badge-hard' : 'badge-normal'}`;
    }

    function filterQuestionsByDifficulty(level){
      const normalized = normalizeDifficulty(level);
      return state.allQuestions.filter(q => normalizeDifficulty(q && q.difficulty) === normalized);
    }
    if(difficultySelect){
      difficultySelect.value = state.difficulty;
      difficultySelect.addEventListener('change', ev => {
        const selected = ev.target.value;
        if(state.allQuestions.length){
          setDifficulty(selected);
        } else {
          state.difficulty = normalizeDifficulty(selected);
        }
      });
    }

    const normalizeDigits = value => (value == null ? '' : String(value).replace(/[０-９]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0)));
    function normalize(value){
      if(value == null) return '';
      return normalizeDigits(value)
        .trim()
        .replace(/\s*([=:=≒≈<>≤≥+\-*/])\s*/g, '$1')
        .replace(/\s+/g, ' ')
        .toLowerCase();
    }

    function asFieldSpec(raw, index){
      if(raw && typeof raw === 'object'){
        const key = raw.key || raw.name || `field${index}`;
        return {
          key,
          label: raw.label || raw.name || `入力${index + 1}`,
          placeholder: raw.placeholder || '',
          autocomplete: raw.autocomplete || 'off',
          autocapitalize: raw.autocapitalize || 'off',
          unit: raw.unit || ''
        };
      }
      if(typeof raw === 'string'){
        return {
          key: `field${index}`,
          label: raw,
          placeholder: '',
          autocomplete: 'off',
          autocapitalize: 'off',
          unit: ''
        };
      }
      return {
        key: `field${index}`,
        label: `入力${index + 1}`,
        placeholder: '',
        autocomplete: 'off',
        autocapitalize: 'off',
        unit: ''
      };
    }

    function inferFieldSpecs(question){
      if(!question) return [];
      const answers = getAnswerList(question);
      if(!answers.length) return [];

      const arrayCandidates = answers.filter(ans => Array.isArray(ans) && ans.length > 1);
      if(arrayCandidates.length){
        const targetLength = arrayCandidates[0].length;
        const consistentLength = arrayCandidates.every(ans => ans.length === targetLength);
        const hasOtherStructures = answers.some(ans => {
          if(ans == null) return false;
          if(Array.isArray(ans)) return false;
          if(typeof ans === 'string') return ans.trim() !== '';
          return true;
        });
        if(consistentLength && targetLength > 0 && !hasOtherStructures){
          return Array.from({ length: targetLength }, (_, idx) => ({
            key: `part${idx}`,
            label: `入力${idx + 1}`,
            placeholder: '',
            autocomplete: 'off',
            autocapitalize: 'off',
            unit: ''
          }));
        }
      }

      const objectCandidates = answers.filter(ans => ans && typeof ans === 'object' && !Array.isArray(ans));
      if(objectCandidates.length){
        const keySets = objectCandidates.map(obj => Object.keys(obj).sort());
        const referenceKeys = keySets[0] || [];
        const hasMultipleKeys = referenceKeys.length > 1;
        const consistentKeys = hasMultipleKeys && keySets.every(keys => {
          if(keys.length !== referenceKeys.length) return false;
          return keys.every((key, idx) => key === referenceKeys[idx]);
        });
        const hasMixedStructures = answers.some(ans => {
          if(ans == null) return false;
          if(typeof ans === 'object' && !Array.isArray(ans)) return false;
          return true;
        });
        if(consistentKeys && !hasMixedStructures){
          return referenceKeys.map(key => ({
            key,
            label: key,
            placeholder: '',
            autocomplete: 'off',
            autocapitalize: 'off',
            unit: ''
          }));
        }
      }

      return [];
    }

    function getFieldSpecs(question){
      if(!question) return [];
      if(Array.isArray(question.fields) && question.fields.length){
        return question.fields.map((raw, idx) => asFieldSpec(raw, idx));
      }
      return inferFieldSpecs(question);
    }

    function compareScalar(expected, actual){
      if(expected == null && actual == null) return true;
      if(expected == null || actual == null) return false;
      return normalize(String(expected)) === normalize(String(actual));
    }

    function matchesAnswer(candidate, userValues, fieldSpecs){
      if(Array.isArray(candidate)){
        if(candidate.length !== fieldSpecs.length) return false;
        return candidate.every((part, idx) => compareScalar(part, userValues[idx] || ''));
      }
      if(candidate && typeof candidate === 'object'){
        const userMap = new Map();
        fieldSpecs.forEach((field, idx) => {
          userMap.set(field.key, userValues[idx] || '');
        });
        return fieldSpecs.every(field => {
          if(!Object.prototype.hasOwnProperty.call(candidate, field.key)) return false;
          const expected = candidate[field.key];
          const actual = userMap.get(field.key);
          if(Array.isArray(expected)){
            return expected.some(option => compareScalar(option, actual));
          }
          return compareScalar(expected, actual);
        });
      }
      return compareScalar(candidate, userValues[0] || '');
    }

    function getAnswerList(question){
      const answers = Array.isArray(question.answers) ? question.answers.slice() : [];
      if(!answers.length && typeof question.answer === 'string'){
        answers.push(question.answer);
      }
      return answers;
    }

    function clearInputEventHandlers(){
      state.inputs.forEach(input => {
        input.removeEventListener('keydown', onInputKeyDown);
      });
    }

    function buildInputs(question){
      clearInputEventHandlers();
      const container = $('#answer-inputs');
      container.innerHTML = '';
      const specs = getFieldSpecs(question);
      const inputs = [];
      if(specs.length){
        specs.forEach((spec, idx) => {
          const wrapper = document.createElement('label');
          wrapper.className = 'field-row';
          const label = document.createElement('span');
          label.className = 'field-label';
          label.textContent = spec.label;
          const input = document.createElement('input');
          input.type = 'text';
          input.placeholder = spec.placeholder || '';
          input.autocomplete = spec.autocomplete || 'off';
          input.autocapitalize = spec.autocapitalize || 'off';
          input.dataset.index = String(idx);
          wrapper.appendChild(label);
          wrapper.appendChild(input);
          if(spec.unit){
            const unit = document.createElement('span');
            unit.className = 'field-unit';
            unit.textContent = spec.unit;
            wrapper.appendChild(unit);
          }
          container.appendChild(wrapper);
          inputs.push(input);
        });
      } else {
        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = '解答を入力';
        input.autocomplete = 'off';
        input.autocapitalize = 'off';
        input.dataset.index = '0';
        container.appendChild(input);
        inputs.push(input);
      }
      inputs.forEach(input => input.addEventListener('keydown', onInputKeyDown));
      state.inputs = inputs;
      state.fieldSpecs = specs;
    }

    function getUserValues(){
      if(!state.inputs.length) return [''];
      return state.inputs.map(input => input.value || '');
    }

    function onInputKeyDown(ev){
      if(ev.key === 'Enter'){
        ev.preventDefault();
        if(state.graded){
          nextQuestion();
        } else {
          checkAnswer();
        }
      }
    }

    function showSetupView(){
      state.started = false;
      if(setupCard) setupCard.style.display = '';
      if(quizCard) quizCard.style.display = 'none';
      if(loadingCard) loadingCard.style.display = 'none';
      if(errorCard) errorCard.style.display = 'none';
      setDifficulty(state.difficulty);
    }

    function setDifficulty(level){
      const normalized = normalizeDifficulty(level);
      state.difficulty = normalized;
      if(difficultySelect){
        difficultySelect.value = normalized;
      }
      state.questions = filterQuestionsByDifficulty(normalized);
      state.index = 0;
      state.attempt = 0;
      if(state.started){
        state.sessionId = createSessionId();
        renderQuestion();
      } else {
        state.sessionId = null;
        clearInputEventHandlers();
        state.inputs = [];
        state.fieldSpecs = [];
        const answerContainer = $('#answer-inputs');
        if(answerContainer){
          answerContainer.innerHTML = '';
        }
        const questionEl = $('#question');
        if(questionEl){
          questionEl.textContent = '';
        }
        if(quizCard) quizCard.style.display = 'none';
        if(loadingCard) loadingCard.style.display = 'none';
        if(errorCard) errorCard.style.display = 'none';
        const btnCheck = $('#btn-check');
        if(btnCheck) btnCheck.disabled = true;
        const btnNext = $('#btn-next');
        if(btnNext) btnNext.disabled = true;
        $('#feedback').textContent = '';
        $('#feedback').className = 'muted';
        setSaveStatus('', 'muted');
        if(startNote){
          startNote.textContent = state.questions.length
            ? '開始を押すと問題が表示されます。'
            : '選択した難易度の問題が見つかりません。別の難易度を選んでください。';
        }
      }
    }

    function renderQuestion(){
      if(!state.questions.length){
        if(quizCard) quizCard.style.display = 'none';
        if(loadingCard){
          loadingCard.style.display = '';
          loadingCard.textContent = '選択した難易度の問題が見つかりませんでした。';
        }
        const btnCheck = $('#btn-check');
        const btnNext = $('#btn-next');
        if(btnCheck) btnCheck.disabled = true;
        if(btnNext) btnNext.disabled = true;
        return;
      }
      const q = state.questions[state.index];
      if(loadingCard) loadingCard.style.display = 'none';
      if(quizCard) quizCard.style.display = '';
      if(errorCard) errorCard.style.display = 'none';
      updateDifficultyBadge(q && q.difficulty ? q.difficulty : state.difficulty);
      const questionEl = $('#question');
      if(questionEl){
        questionEl.textContent = q.prompt || q.question || '';
      }
      buildInputs(q);
      state.inputs.forEach(input => { input.value = ''; });
      $('#feedback').textContent = '';
      $('#feedback').className = 'muted';
      setSaveStatus('', 'muted');
      state.graded = false;
      const btnCheck = $('#btn-check');
      if(btnCheck) btnCheck.disabled = false;
      const btnNext = $('#btn-next');
      if(btnNext) btnNext.disabled = true;
      if(quizCard) quizCard.style.display = '';
      if(loadingCard) loadingCard.style.display = 'none';
      if(state.inputs[0]){
        state.inputs[0].focus();
      }
    }

    function sanitizeExplain(raw){
      if(!raw) return '';
      let text = String(raw).trim();
      text = text.replace(/(?:答え|正解)[:：]?.*$/u, '').trim();
      return text;
    }

    function buildExplain(q){
      if(!q || !q.explain) return '';
      const hint = sanitizeExplain(q.explain);
      if(!hint) return '';
      return `<div class="muted" style="margin-top:8px">解説: ${hint}</div>`;
    }

    function checkAnswer(){
      if(state.graded) return;
      const q = state.questions[state.index];
      if(!q){
        $('#feedback').className = 'ng';
        $('#feedback').textContent = '問題が読み込めませんでした。';
        return;
      }
      const userValues = getUserValues();
      const fieldSpecs = state.fieldSpecs;
      const answers = getAnswerList(q);
      if(!answers.length){
        $('#feedback').className = 'muted';
        $('#feedback').textContent = '正解が登録されていません。';
        state.graded = true;
        const btnNext = $('#btn-next');
        if(btnNext) btnNext.disabled = false;
        return;
      }
      const isCorrect = answers.some(candidate => matchesAnswer(candidate, userValues, fieldSpecs));
      state.graded = true;
      const btnNext = $('#btn-next');
      if(btnNext) btnNext.disabled = false;
      const explain = buildExplain(q);
      state.attempt += 1;
      sendMathResult(q, isCorrect, userValues, fieldSpecs);
      if(isCorrect){
        $('#feedback').className = 'ok';
        $('#feedback').innerHTML = `✅ 正解です！${explain}`;
      } else {
        $('#feedback').className = 'ng';
        const retryMessage = '❌ 不正解。もう一度チャレンジしてみましょう。';
        $('#feedback').innerHTML = explain ? `${retryMessage}${explain}` : retryMessage;
      }
    }

    function nextQuestion(){
      if(!state.graded) checkAnswer();
      state.index = (state.index + 1) % state.questions.length;
      if(state.index === 0){
        state.sessionId = createSessionId();
        state.attempt = 0;
      }
      renderQuestion();
    }

    if(startButton){
      startButton.addEventListener('click', ev => {
        ev.preventDefault();
        if(startButton.disabled) return;
        if(!state.allQuestions.length) return;
        state.started = true;
        if(setupCard) setupCard.style.display = 'none';
        setDifficulty(state.difficulty);
        if(startNote){
          startNote.textContent = '出題条件を変更するには「出題条件を変更」を押してください。';
        }
      });
    }

    if(changeSettingsButton){
      changeSettingsButton.addEventListener('click', ev => {
        ev.preventDefault();
        showSetupView();
        if(startNote){
          startNote.textContent = state.questions.length
            ? '開始を押すと問題が表示されます。'
            : '選択した難易度の問題が見つかりません。別の難易度を選んでください。';
        }
      });
    }

    $('#btn-check').addEventListener('click', checkAnswer);
    $('#btn-next').addEventListener('click', nextQuestion);
    function createSessionId(){
      return `math-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;
    }

    function toAnswerPayload(question, userValues, fieldSpecs, isCorrect){
      const payload = {
        id: question && question.id ? String(question.id) : null,
        correct: !!isCorrect,
        prompt: question && (question.prompt || question.question) ? String(question.prompt || question.question) : '',
      };
      payload.difficulty = normalizeDifficulty(question && question.difficulty);
      if(fieldSpecs && fieldSpecs.length){
        const answerMap = {};
        fieldSpecs.forEach((field, idx) => {
          const key = field && field.key ? String(field.key) : `field${idx}`;
          answerMap[key] = userValues[idx] || '';
        });
        payload.response = answerMap;
      } else {
        payload.response = Array.isArray(userValues) && userValues.length === 1 ? userValues[0] : userValues;
      }
      const answers = getAnswerList(question);
      if(answers && answers.length){
        payload.acceptedAnswers = answers;
      }
      return payload;
    }

    function sendMathResult(question, isCorrect, userValues, fieldSpecs){
      if(!question) return;
      if(!state.sessionId){
        state.sessionId = createSessionId();
      }
      const questionDifficulty = normalizeDifficulty(question && question.difficulty);
      const record = {
        subject: SUBJECT,
        user: 'math',
        mode: 'math-drill',
        sessionId: state.sessionId,
        attempt: state.attempt,
        questionIndex: state.index,
        difficulty: questionDifficulty,
        total: 1,
        correct: isCorrect ? 1 : 0,
        wrong: isCorrect ? 0 : 1,
        endedAt: new Date().toISOString(),
        answered: [toAnswerPayload(question, userValues, fieldSpecs, isCorrect)]
      };
      record.answered[0].difficulty = questionDifficulty;
      setSaveStatus('採点結果を送信しています…', 'muted');
      fetch(RESULT_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(record)
      })
        .then(() => {
          setSaveStatus('採点結果を記録しました。', 'success');
        })
        .catch(err => {
          console.warn('数学の結果送信に失敗しました', err);
          setSaveStatus('結果の送信に失敗しました。時間をおいて再度お試しください。', 'error');
        });
    }

    fetch(QUESTIONS_URL, { cache: 'no-store' })
      .then(res => {
        if(!res.ok) throw new Error(`fetch ${QUESTIONS_URL} ${res.status}`);
        return res.json();
      })
      .then(data => {
        const loaded = Array.isArray(data.questions) ? data.questions : [];
        state.allQuestions = loaded.map(q => ({ ...q, difficulty: normalizeDifficulty(q && q.difficulty) }));
        if(!state.allQuestions.length){
          if(loadingCard){
            loadingCard.style.display = '';
            loadingCard.textContent = '問題が見つかりませんでした。';
          }
          if(startButton){
            startButton.disabled = true;
            startButton.textContent = '演習を開始';
          }
          if(startNote){
            startNote.textContent = '問題が見つからないため演習を開始できません。';
          }
          return;
        }
        if(loadingCard) loadingCard.style.display = 'none';
        if(startButton){
          startButton.disabled = false;
          startButton.textContent = '演習を開始';
        }
        if(startNote){
          startNote.textContent = '開始を押すと問題が表示されます。';
        }
        if(setupCard) setupCard.style.display = '';
        setDifficulty(state.difficulty);
      })
      .catch(err => {
        if(loadingCard) loadingCard.style.display = 'none';
        if(quizCard) quizCard.style.display = 'none';
        if(errorCard){
          errorCard.style.display = '';
          errorCard.textContent = `問題の読み込みに失敗しました: ${err.message}`;
        }
        if(startButton){
          startButton.disabled = true;
          startButton.textContent = '演習を開始';
        }
        if(startNote){
          startNote.textContent = '問題の読み込みに失敗しました。時間をおいて再度お試しください。';
        }
        if(setupCard) setupCard.style.display = '';
      });
</script>
</body>
</html>
