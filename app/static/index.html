<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>è‹±èªã‚¯ã‚¤ã‚ºï½œä¸¦ã¹æ›¿ãˆï¼‹å˜èªï¼ˆæ„å‘³â†’ã‚¹ãƒšãƒ«ï¼‰</title>
  <style>
    :root{ --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --border:#1f2937; --accent:#3b82f6; --warn:#ef4444 }
    *{ box-sizing:border-box }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif; -webkit-text-size-adjust:100% }
    header{ position:sticky; top:0; background:rgba(17,24,39,.9); backdrop-filter:saturate(150%) blur(6px); border-bottom:1px solid var(--border); z-index:10 }
    .container{ max-width:980px; margin:0 auto; padding:16px }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; margin:16px 0 }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
    .pill{ display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; border:1px solid #334155; background:#0b1220; color:#cbd5e1; font-size:12px }
    input,select{ background:#0b1220; color:#e5e7eb; border:1px solid #334155; border-radius:12px; padding:8px 10px }
    button{ border:1px solid #334155; background:#1f2937; color:#e5e7eb; border-radius:12px; padding:10px 14px; font-weight:700; cursor:pointer }
    button.primary{ background:var(--accent); border-color:var(--accent); color:white }
    button.warn{ background:var(--warn); border-color:var(--warn); color:white }
    button:disabled{ opacity:.5; cursor:not-allowed }
    .muted{ color:var(--muted) }
    .right{ margin-left:auto }
    .kbd{ font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; border:1px solid #334155; background:#0b1220; border-radius:6px; padding:2px 6px; color:#cbd5e1 }
    .target{ min-height:52px; padding:8px; background:#0b1220; border:2px dashed var(--accent); border-radius:12px; display:flex; gap:8px; flex-wrap:wrap }
    .bank{ display:flex; flex-wrap:wrap; gap:8px }
    .chip{ background:#0b1220; border:1px solid #334155; border-radius:999px; padding:8px 12px; cursor:pointer; transition:.15s; user-select:none; min-height:44px }
    .chip:hover{ transform:translateY(-1px) }
    .chip.used{ opacity:.45; cursor:default }
    .ok{ color:#22c55e } .ng{ color:#ef4444 }
    .field{ display:flex; gap:8px; align-items:center }
    .input{ background:#0b1220; color:#e5e7eb; border:1px solid #334155; border-radius:10px; padding:10px 12px; min-width:240px }

    /* iOS Safari ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã®è‡ªå‹•ã‚ºãƒ¼ãƒ æŠ‘æ­¢ï¼š16pxä»¥ä¸Šã«çµ±ä¸€ */
    @supports (-webkit-touch-callout: none) {
      input, select, textarea { font-size:16px; line-height:1.2; }
      .input { font-size:16px; }
      #count { font-size:16px; }
    }
    input, select, textarea { min-height:44px; }

    /* --- ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ– & æ“ä½œãƒœã‚¿ãƒ³ã®æŠ¼ã—ã‚„ã™ã•æ”¹å–„ --- */
    :root{ --tap:44px }
    body{ touch-action:manipulation }
    #vocab-input{ width:100% }
    #target,#bank{ gap:10px }
    #bank{ max-height:40vh; overflow:auto; padding-bottom:6px }

    /* æ“ä½œãƒœã‚¿ãƒ³é…ç½®ï¼šè§£ç­”ç¢ºèªã‚’æœ€å„ªå…ˆãƒ»å¤§ãã */
    #quiz .actions{ display:flex; flex-wrap:wrap; gap:10px; }
    #btn-check{ order:1; flex:1 1 100%; padding:14px 18px; font-size:18px; }
    #btn-next{ order:2; flex:1 1 48%; }
    #btn-undo, #btn-clear, #btn-speak{ order:3; flex:1 1 30%; min-width:120px }
    @media (min-width:820px){
      #btn-check{ flex-basis:60%; font-size:16px; }
      #btn-next{ flex-basis:auto; }
    }
  </style>
</head>
<body>
  <header>
    <div class="container row">
      <div>
        <h2 style="margin:0">è‹±èªã‚¯ã‚¤ã‚º <span class="muted">ï¼ˆä¸¦ã¹æ›¿ãˆï¼‹å˜èªï¼‰</span></h2>
        <div class="muted" style="font-size:12px">å¤–éƒ¨JSONï¼å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ï¼ä¸€å•ä¸€æ¡ç‚¹ï¼å®Œäº†æ™‚ã¯æœ€å°ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ã‚µãƒ¼ãƒä¿å­˜ã€‚</div>
      </div>
      <div class="right pill" id="user-pill">ğŸ‘¤ ã‚²ã‚¹ãƒˆ</div>
    </div>
  </header>

  <main class="container">
    <!-- è¨­å®š -->
    <section class="card" id="setup">
      <div class="row">
        <label class="row" style="gap:6px"><span class="muted">å­¦ç¿’è€…å</span><input id="learner" type="text" placeholder="taro" autocomplete="off" autocapitalize="off" list="user-suggestions" /></label><datalist id="user-suggestions"></datalist>
        <label class="row" style="gap:6px"><span class="muted">1ã‚»ãƒƒãƒˆã®å‡ºé¡Œæ•°</span><input id="count" type="number" min="3" max="20" value="5" style="width:80px"/></label>
        <label class="row" style="gap:6px"><span class="muted">å‡ºé¡Œã‚¿ã‚¤ãƒ—</span>
          <select id="qtype">
            <option value="reorder">ä¸¦ã¹æ›¿ãˆï¼ˆæ–‡æ³•ï¼‰</option>
            <option value="vocab" selected>å˜èªï¼ˆæ„å‘³â†’ã‚¹ãƒšãƒ«ï¼‰</option>
          </select>
        </label>
        <label class="row" style="gap:6px"><span class="muted">ãƒ¬ãƒ™ãƒ«</span>
          <select id="level-filter">
            <option value="Lv1" selected>Lv1ï¼ˆä¸­å­¦ä¸€å¹´ç”Ÿç›¸å½“ï¼‰</option>
            <option value="Lv2">Lv2ï¼ˆä¸­å­¦äºŒå¹´ç”Ÿç›¸å½“ï¼‰</option>
            <option value="Lv3">Lv3ï¼ˆä¸­å­¦ä¸‰å¹´ç”Ÿç›¸å½“ï¼‰</option>
          </select>
        </label>
        <label class="row" style="gap:6px"><span class="muted">ãƒ¦ãƒ‹ãƒƒãƒˆ</span>
          <select id="unit-filter">
            <option value="">å…¨ãƒ¦ãƒ‹ãƒƒãƒˆ</option>
          </select>
        </label>
        <button class="primary" id="btn-start">â–¶ å­¦ç¿’ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        <button id="btn-weak" title="éå»7æ—¥ã®æ­£ç­”ç‡ãŒä½ã„å•é¡Œ">ğŸ¯ å¼±ç‚¹å¯¾ç­–ï¼ˆéå»7æ—¥ï¼‰</button>
      </div>
      <div class="muted" style="margin-top:8px">
        ä¸¦ã¹æ›¿ãˆ: <span class="kbd">1-9</span> ã§é¸æŠã€<span class="kbd">Backspace</span> ã§æˆ»ã™ã€<span class="kbd">Enter</span> ã§æ¡ç‚¹/æ¬¡ã¸ã€‚<br>
        å˜èª: å…¥åŠ›æ¬„ã«ã‚¹ãƒšãƒ«ã‚’å…¥åŠ›ï¼ˆè‹±å­—ãƒ»å¤§æ–‡å­—å°æ–‡å­—ã¯ä¸å•ï¼‰ã€‚
        <br>ãƒ¬ãƒ™ãƒ«ã®ç›®å®‰: Lv1ï¼ä¸­å­¦ä¸€å¹´ç”Ÿã€Lv2ï¼ä¸­å­¦äºŒå¹´ç”Ÿã€Lv3ï¼ä¸­å­¦ä¸‰å¹´ç”Ÿã€‚
      </div>
    </section>

    <!-- ã‚¯ã‚¤ã‚ºï¼ˆå…±é€šãƒ˜ãƒƒãƒ€ï¼‰ -->
    <section class="card" id="quiz" style="display:none">
      <div class="row">
          <span class="pill" id="status">Q 1/5</span>
          <span class="pill">æ­£è§£: <b id="stat-correct">0</b></span>
          <span class="pill">èª¤ç­”: <b id="stat-wrong">0</b></span>
          <span class="pill" id="stat-streak">é€£ç¶šæ­£è§£: --</span>
          <span class="pill" id="stat-accuracy">æ­£è§£ç‡: --</span>
          <span class="pill" id="stat-stage">ãƒ©ãƒ³ã‚¯: --</span>
          <span class="pill" id="stat-bucket">ãƒã‚±ãƒƒãƒˆ: --</span>
          <span class="pill right" id="timer">â± 00:00</span>
      </div>
      <div id="prompt" class="muted">ï¼ˆæ—¥æœ¬èªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰</div>

      <!-- ä¸¦ã¹æ›¿ãˆUI -->
      <div id="ui-reorder">
        <div id="target" class="target" aria-label="ç­”ãˆã®ã‚¨ãƒªã‚¢"></div>
        <div id="bank" class="bank" aria-label="å˜èªã®ã‚¨ãƒªã‚¢"></div>
      </div>

      <!-- å˜èªUI -->
      <div id="ui-vocab" style="display:none; margin-top:10px">
        <div class="field">
          <input id="vocab-input" class="input" type="text" placeholder="ã‚¹ãƒšãƒ«ã‚’å…¥åŠ›ï¼ˆä¾‹: interestingï¼‰" autocomplete="off" autocapitalize="off" autocorrect="off" inputmode="latin" />
          <button id="btn-clear-vocab">ğŸ§¹ ã‚¯ãƒªã‚¢</button>
        </div>
        <div class="muted" id="vocab-tip" style="margin-top:6px"></div>
      </div>

      <div class="row actions" style="margin-top:10px">
        <button class="primary" id="btn-check">ç­”ãˆåˆã‚ã› <span class="kbd">Enter</span></button>
        <button id="btn-next" disabled>æ¬¡ã®å•é¡Œ â–¶</button>
        <button id="btn-undo">â†© ã²ã¨ã¤æˆ»ã™</button>
        <button id="btn-clear">ğŸ§¹ ã‚¯ãƒªã‚¢</button>
        <button id="btn-speak">ğŸ”Š æ­£è§£æ–‡/å˜èª</button>
        <button id="btn-hint">ğŸ’¡ ãƒ’ãƒ³ãƒˆ</button>
      </div>
      <div id="explain" class="muted" style="min-height:1.6em"></div>
    </section>

    <!-- ã‚»ãƒƒãƒˆçµ‚äº† -->
    <section class="card" id="finished" style="display:none">
      <h3 style="margin:0 0 8px">ã‚»ãƒƒãƒˆå®Œäº†ï¼</h3>
      <p id="summary" class="muted"></p>
      <p id="save-status" class="muted">çµæœé€ä¿¡: å¾…æ©Ÿä¸­â€¦</p>
      <div class="row">
        <button class="primary" id="btn-review-thisset" disabled>â—ã“ã®ã‚»ãƒƒãƒˆã®ã¾ã¡ãŒã„ã§å¾©ç¿’</button>
        <button class="primary" id="btn-nextset">â–¶ æ¬¡ã®å•é¡Œç¾¤ï¼ˆæ¬¡ã‚»ãƒƒãƒˆï¼‰</button>
        <button id="btn-dashboard">ğŸ“Š æˆç¸¾ã‚’è¦‹ã‚‹</button>
        <button class="warn right" id="btn-to-setup">è¨­å®šã«æˆ»ã‚‹</button>
      </div>
    </section>
  </main>

  <script>
    /********** è¨­å®š **********/
    const SUBJECT = 'english';
    const QUESTIONS_URL = `/data/${SUBJECT}/questions.json`; // Flaskã§é…ä¿¡
    const DEFAULT_ENDPOINT = "/api/results";
    const LEVEL_ORDER = ['Lv1','Lv2','Lv3'];
    const DEFAULT_LEVEL = LEVEL_ORDER[0];

    // è¨­å®šã®è¨˜æ†¶ç”¨ã‚­ãƒ¼
    const REMEMBER_USER_KEY = 'quiz:lastUser';
    const REMEMBER_QTYPE_KEY = 'quiz:lastQType';
    const REMEMBER_UNIT_KEY = 'quiz:lastUnitFilter';
    const REMEMBER_LEVEL_KEY = 'quiz:lastLevel';
    const USER_SUGGEST_KEY = 'quiz:userList';

    /********** å•é¡Œãƒ­ãƒ¼ãƒ‰ **********/
    let BANK_REORDER = [];
    let BANK_VOCAB = [];

    const toAnswerList = (value)=>{
      if(Array.isArray(value)){
        return value
          .map(v=>typeof v==='string'? v.trim(): '')
          .filter(v=>v);
      }
      if(typeof value==='string'){
        const trimmed = value.trim();
        return trimmed? [trimmed] : [];
      }
      return [];
    };

    const collectAnswerSet = (item)=>{
      const primary = toAnswerList(item.en);
      const extras = [];
      [item.accept, item.accepts, item.answers, item.alternates, item.variants]
        .forEach(src=>{ toAnswerList(src).forEach(ans=>extras.push(ans)); });
      const merged = [...primary, ...extras];
      if(!merged.length && typeof item.en==='string'){
        const fallback = item.en.trim();
        if(fallback) merged.push(fallback);
      }
      const unique = [];
      merged.forEach(ans=>{ if(!unique.includes(ans)) unique.push(ans); });
      return unique;
    };

    const normalizeLevel = (value)=>{
      const str = (value==null ? '' : String(value)).trim();
      if(LEVEL_ORDER.includes(str)) return str;
      const match = str.match(/([1-3])/);
      if(match){
        const candidate = `Lv${match[1]}`;
        if(LEVEL_ORDER.includes(candidate)) return candidate;
      }
      return DEFAULT_LEVEL;
    };

    const levelIndex = (value)=>{
      const lvl = normalizeLevel(value);
      const idx = LEVEL_ORDER.indexOf(lvl);
      return idx === -1 ? LEVEL_ORDER.length : idx;
    };

    const buildQuestion = (item, type)=>{
      const answers = collectAnswerSet(item);
      const primary = answers[0] || (typeof item.en==='string'? item.en.trim(): '');
      const base = {
        type,
        id: item.id||null,
        unit: item.unit||null,
        jp: item.jp,
        en: primary,
        answers,
        tip: item.tip||'',
        explain: item.explain||'',
        level: normalizeLevel(item.level)
      };
      if(type==='reorder'){
        base.chunks = item.chunks;
        base.wrong = item.wrong||[];
      } else if(type==='vocab'){
        base.pos = item.pos||'';
      }
      return base;
    };
    async function ensureQuestions(){
      if (BANK_REORDER.length || BANK_VOCAB.length){ renderUnitFilterOptions(); return; }
      const res = await fetch(QUESTIONS_URL, { cache: "no-store" });
      if (!res.ok) throw new Error("è³ªå•ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—: " + res.status);
      const data = await res.json();
      // äº’æ›: æ—§å½¢å¼ questions ã¯ä¸¦ã¹æ›¿ãˆæ‰±ã„
      BANK_REORDER = (data.questions||data.reorder||[]).map(q=>buildQuestion(q, 'reorder'));
      BANK_VOCAB   = (data.vocab||[]).map(v=>buildQuestion(v, 'vocab'));
      renderUnitFilterOptions();
    }

    /********** çŠ¶æ…‹ **********/
    const state = {
      user:'guest', endpoint: DEFAULT_ENDPOINT,
      qType:'reorder',
      unitFilter:'',
      levelMax: DEFAULT_LEVEL,
      totalPerSet:5, order:[], setIndex:0,
      qIndex:0, correct:0, wrong:0,
      startedAt:null, seconds:0, timerId:null,
      answered:[],   // ã‚µãƒ¼ãƒé€ä¿¡ç”¨ï¼ˆé€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼‰
      reviewed:[],   // ã‚µãƒ¼ãƒé€ä¿¡ç”¨ï¼ˆå¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ï¼‰
      graded:false,  // ä¸€å•ä¸€æ¡ç‚¹
      mode:'normal',
      reviewStrategy:'all', // 'all' | 'recent'
      weakWindowDays:7,      // éå»â—¯æ—¥ã‚’å¯¾è±¡
      missedSetDeck: [],   // ã“ã®ã‚»ãƒƒãƒˆã§é–“é•ãˆãŸå•é¡Œã®ãƒ‡ãƒƒã‚­
    };

    const $ = s=>document.querySelector(s);
    const $$ = s=>Array.from(document.querySelectorAll(s));

    /********** ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ **********/
    const fmtTime = s=>{ const m=String(Math.floor(s/60)).padStart(2,'0'); const r=String(s%60).padStart(2,'0'); return `${m}:${r}` };
    const shuffle = arr=>arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);
    const NBSP = String.fromCharCode(160);
    const normalizeDigits = s=> (s==null ? '' : String(s).replace(/[ï¼-ï¼™]/g, ch=> String.fromCharCode(ch.charCodeAt(0)-0xFEE0)));
    const normalizeSpaces = s=> normalizeDigits(s).replace(new RegExp(`[${NBSP}\\s]+`,'g'),' ').trim();
    const normalizeEndPunc = (s, keep=false)=> keep ? s.replace(/\s+([.,!?])/g, "$1") : s.replace(/\s*[.,!?]$/,'');
    const normalizeWord = s=> normalizeSpaces(s).toLowerCase();
    const normalizeUnit = u=> (u===null || u===undefined ? '' : String(u).trim());
    const HARD_STREAK = 2;
    const nowISO = ()=> new Date().toISOString();

    async function postJSON(url, data, timeoutMs=6000){
      const ctrl = new AbortController();
      const t = setTimeout(()=>ctrl.abort(), timeoutMs);
      try{
        const res = await fetch(url,{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data), signal: ctrl.signal});
        clearTimeout(t);
        return {ok: res.ok, status: res.status};
      }catch(e){ clearTimeout(t); return {ok:false, error:String(e)}; }
    }

    async function startSetCustom(customDeck){
      try{ await ensureQuestions(); }catch(e){ alert(e.message||e); return; }
      if(!customDeck || !customDeck.length){ alert('ã“ã®ã‚»ãƒƒãƒˆã®é–“é•ã„ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚'); return; }

      // ã‚»ãƒƒãƒˆåˆæœŸåŒ–
      state.qIndex=0; state.correct=0; state.wrong=0; state.answered=[]; state.reviewed=[]; state.graded=false;
      $('#stat-correct').textContent='0'; $('#stat-wrong').textContent='0';

      // ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ãƒ‡ãƒƒã‚­ã«æµã—è¾¼ã‚€ï¼ˆæ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯æµç”¨ï¼‰
      window.__REVIEW_DECK__ = customDeck.map(q=>({ ...q }));
      state.order = [...window.__REVIEW_DECK__.keys()].map(i=>({idx:i, bucket:null, streak:0}));
      state.mode = 'review';
      // è¡¨ç¤ºUIã‚’åˆã‚ã›ã‚‹ï¼ˆä¸¦ã¹æ›¿ãˆ/å˜èªï¼‰
      state.qType = (window.__REVIEW_DECK__[0]?.type) || state.qType;

      show('quiz'); startTimer(); renderQuestion();
    }

    /********** è¨­å®šã®è¨˜æ†¶ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åãƒ»å‡ºé¡Œã‚¿ã‚¤ãƒ—ï¼‰ **********/
    function populateUserSuggestions(){
      const dl=document.getElementById('user-suggestions'); if(!dl) return;
      const list=JSON.parse(localStorage.getItem(USER_SUGGEST_KEY)||'[]');
      dl.innerHTML='';
      list.forEach(name=>{ const opt=document.createElement('option'); opt.value=name; dl.appendChild(opt); });
    }

    function readRememberedUnitMap(){
      try{
        const raw = localStorage.getItem(REMEMBER_UNIT_KEY);
        if(!raw) return {};
        const data = JSON.parse(raw);
        return (data && typeof data === 'object') ? data : {};
      }catch(e){
        return {};
      }
    }
    function writeRememberedUnitMap(map){
      try{
        localStorage.setItem(REMEMBER_UNIT_KEY, JSON.stringify(map));
      }catch(e){
        // ignore
      }
    }
    function getRememberedUnitFilter(qType){
      const map = readRememberedUnitMap();
      const val = map && typeof map === 'object' ? map[qType] : '';
      return (typeof val === 'string') ? val : '';
    }
    function rememberUnitFilter(qType, value){
      const map = readRememberedUnitMap();
      const v = (value || '').trim();
      if(v){ map[qType] = v; }
      else { delete map[qType]; }
      writeRememberedUnitMap(map);
    }

    function renderUnitFilterOptions(){
      const sel = document.getElementById('unit-filter');
      if(!sel) return;
      const deckArr = deckByType(state.qType).filter(q=> levelIndex(q.level) <= levelIndex(state.levelMax));
      const units = Array.from(new Set(deckArr.map(q=>normalizeUnit(q.unit)).filter(u=>u))).sort((a,b)=>a.localeCompare(b, 'ja', { numeric:true, sensitivity:'base' }));
      sel.innerHTML='';
      const optAll=document.createElement('option'); optAll.value=''; optAll.textContent='å…¨ãƒ¦ãƒ‹ãƒƒãƒˆ'; sel.appendChild(optAll);
      units.forEach(u=>{ const opt=document.createElement('option'); opt.value=u; opt.textContent=u; sel.appendChild(opt); });
      if(deckArr.length===0){
        sel.value='';
        sel.disabled=true;
        if(state.unitFilter){
          state.unitFilter='';
          rememberUnitFilter(state.qType, '');
        }
        return;
      }
      sel.disabled=false;
      if(state.unitFilter && !units.includes(state.unitFilter)){
        state.unitFilter='';
        rememberUnitFilter(state.qType, '');
      }
      sel.value = state.unitFilter || '';
    }
    function loadRememberedSettings(){
      const u=(localStorage.getItem(REMEMBER_USER_KEY)||'').trim();
      if(u){ state.user=u; const inp=document.getElementById('learner'); if(inp) inp.value=u; const pill=document.getElementById('user-pill'); if(pill) pill.textContent=`ğŸ‘¤ ${u}`; }
      const qt=(localStorage.getItem(REMEMBER_QTYPE_KEY)||'').trim();
      const qs=document.getElementById('qtype');
      if(qt){ state.qType=qt; if(qs) qs.value=qt; }
      const levelSel = document.getElementById('level-filter');
      const rememberedLevel = (localStorage.getItem(REMEMBER_LEVEL_KEY)||DEFAULT_LEVEL).trim();
      const normalizedLevel = LEVEL_ORDER.includes(rememberedLevel) ? rememberedLevel : DEFAULT_LEVEL;
      state.levelMax = normalizedLevel;
      if(levelSel){ levelSel.value = normalizedLevel; }
      state.unitFilter = getRememberedUnitFilter(state.qType);
      const unitSel = document.getElementById('unit-filter');
      if(unitSel){ unitSel.value = state.unitFilter || ''; }
      state.endpoint=DEFAULT_ENDPOINT;
      populateUserSuggestions();
    }
    function rememberSettings(){
      if(state.user) localStorage.setItem(REMEMBER_USER_KEY, state.user);
      if(state.qType) localStorage.setItem(REMEMBER_QTYPE_KEY, state.qType);
      localStorage.setItem(REMEMBER_LEVEL_KEY, state.levelMax || DEFAULT_LEVEL);
      rememberUnitFilter(state.qType, state.unitFilter||'');
      const raw=JSON.parse(localStorage.getItem(USER_SUGGEST_KEY)||'[]');
      const list=Array.isArray(raw)? raw.slice(0) : [];
      if(state.user){
        const i=list.indexOf(state.user); if(i!==-1) list.splice(i,1);
        list.unshift(state.user);
        if(list.length>20) list.length=20;
        localStorage.setItem(USER_SUGGEST_KEY, JSON.stringify(list));
      }
      populateUserSuggestions();
    }

    /********** ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰ **********/
    const storeKey=(u)=>`quiz:${u}`;
    const wrongKey=(u,t)=>`quiz:${u}:wrong:${t}`;
    function getHistory(){ const raw=JSON.parse(localStorage.getItem(storeKey(state.user))||'{}'); return raw.history||[]; }
    function pushHistory(session){ const raw=JSON.parse(localStorage.getItem(storeKey(state.user))||'{}'); raw.history=raw.history||[]; raw.history.unshift(session); localStorage.setItem(storeKey(state.user), JSON.stringify(raw)); }
    function getWrongQueue(){ return JSON.parse(localStorage.getItem(wrongKey(state.user, state.qType))||'[]'); }
    function setWrongQueue(list){ localStorage.setItem(wrongKey(state.user, state.qType), JSON.stringify(list.slice(0,150))); }
    function addWrongLocal(item){ const q=getWrongQueue(); const key=item.id?`id:${item.id}`:`${item.en}__${item.jp}`; if(!q.some(x=>x.key===key)){ q.unshift({...item, key}); setWrongQueue(q); } }
    function removeFromWrongIfMatched(rec){ const q=getWrongQueue(); const key=rec.id?`id:${rec.id}`:null; let idx=-1; if(key){ idx=q.findIndex(x=>x.key===key); } if(idx===-1){ idx=q.findIndex(x=>x.en===rec.en && x.jp===rec.jp); } if(idx>-1){ q.splice(idx,1); setWrongQueue(q); } }

    /********** ç”»é¢åˆ‡æ›¿ **********/
    function show(id){ ['setup','quiz','finished'].forEach(sec=>{ const el=$(`#${sec}`); if(!el) return; el.style.display = (sec===id)?'block':'none'; }); }

    /********** ãƒ‡ãƒƒã‚­å–å¾— **********/
    function deckByType(type){ return type==='reorder' ? BANK_REORDER : BANK_VOCAB; }
    function deck(){
      const all = deckByType(state.qType);
      if(state.mode==='review') return all;
      const maxLevelIdx = levelIndex(state.levelMax);
      const byLevel = all.filter(q=> levelIndex(q.level) <= maxLevelIdx);
      const shouldFilterByUnit = state.mode==='normal' || state.mode==='weak';
      const unit = shouldFilterByUnit ? (state.unitFilter || '') : '';
      if(!unit) return byLevel;
      return byLevel.filter(q=> normalizeUnit(q.unit) === unit);
    }

    function parseIsoDate(value){
      if(!value) return null;
      const date = new Date(value);
      return Number.isNaN(date.getTime()) ? null : date;
    }

    function isSameCalendarDay(a,b){
      if(!(a instanceof Date) || !(b instanceof Date)) return false;
      return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
    }

    /********** ã‚»ãƒƒãƒˆæº–å‚™ **********/
    async function buildOrderFromBank(){
      const deckArr = deck();
      const n = Math.min(state.totalPerSet, deckArr.length);

      // ãƒã‚±ãƒƒãƒˆï¼š
      // A: ã‚µãƒ¼ãƒè¨˜éŒ²ã§ç›´è¿‘ã®å›ç­”ãŒæ­£è§£ã®å•é¡Œ
      // B: ãã‚Œä»¥å¤–ï¼ˆèª¤ç­”ã¾ãŸã¯æœªå›ç­”ï¼‰ã®å•é¡Œ
      const bucketA = [];
      const bucketB = [];

      // ã‚µãƒ¼ãƒã‹ã‚‰å„å•é¡Œã®çµ±è¨ˆã‚’å–å¾—
      const stats = await Promise.all(
        deckArr.map(q=>{
          if(!state.user || !q.id) return Promise.resolve(null);
          const url = `/api/stats?user=${encodeURIComponent(state.user)}&id=${encodeURIComponent(q.id)}&subject=${encodeURIComponent(SUBJECT)}`;
          return fetch(url,{cache:'no-store'})
            .then(r=>r.ok?r.json():null)
            .catch(()=>null);
        })
      );

      for(let i=0;i<deckArr.length;i++){
        const s = stats[i];
        if(!s || typeof s !== 'object'){ bucketB.push({idx:i, streak:0}); continue; }
        const lastWrong = parseIsoDate(s.lastWrongAt);
        const lastCorrect = parseIsoDate(s.lastCorrectAt);
        const recoveredSameDay = lastWrong && lastCorrect && isSameCalendarDay(lastWrong, lastCorrect) && lastCorrect.getTime() >= lastWrong.getTime();
        if(recoveredSameDay){ bucketB.push({idx:i, streak:0}); continue; }
        const streak = s.streak||0;
        const ans = s.answered||0;
        const ok = s.correct||0;
        const accuracy = ans? (ok/ans) : 0;
        if(streak>0){
          bucketA.push({ idx:i, streak, accuracy, rand:Math.random() });
        }else{
          bucketB.push({idx:i, streak:0});
        }
      }

      // é€£ç¶šæ­£è§£æ•°ã®å°‘ãªã„é † â†’ æ­£è§£ç‡ã®ä½ã„é † â†’ ä¹±æ•°
      const compareA = (a, b) =>
        (a.streak - b.streak) || (a.accuracy - b.accuracy) || (a.rand - b.rand);

      const order = [];
      bucketA.sort(compareA);
      if(bucketA.length>0){
        const picked = bucketA.shift();
        order.push({ idx:picked.idx, bucket:'A', streak:picked.streak });
      }

      const B = shuffle(bucketB); // ãƒ©ãƒ³ãƒ€ãƒ 
      while(order.length < n && B.length){
        const b = B.shift();
        order.push({ idx:b.idx, bucket:'B', streak:b.streak });
      }

      bucketA.forEach(x=>x.rand=Math.random());
      bucketA.sort(compareA);
      while(order.length < n && bucketA.length){
        const next = bucketA.shift();
        order.push({ idx:next.idx, bucket:'A', streak:next.streak });
      }

      return order;
    }






    function buildOrderFromWrong(strategy='all'){
      const wrong=getWrongQueue();
      if(wrong.length===0) return [];
      const need = Math.min(state.totalPerSet, wrong.length);
      let pool = [];
      if(strategy==='recent'){
        const cutoff = Date.now() - 7*24*3600*1000;
        const recent = wrong.filter(x=> x.at && (new Date(x.at).getTime()>=cutoff))
                            .sort((a,b)=> new Date(b.at)-new Date(a.at));
        pool = recent.slice(0, need);
        if(pool.length < need){
          const rest = wrong.filter(x=> !pool.includes(x));
          pool = pool.concat(rest.slice(0, need - pool.length));
        }
      }else{
        pool = wrong.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]).slice(0, need);
      }
      window.__REVIEW_DECK__ = pool.map(w=>({ ...w }));
      return [...window.__REVIEW_DECK__.keys()];
    }

    // === æˆç¸¾ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰: éå»ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å¼±ç‚¹æŠ½å‡º ===
    const PERF_KEY = (u)=>`quiz:${u}:perf`;
    const qKeyOf = (q)=> q.id? `id:${q.id}` : `${q.type}:${q.en}__${q.jp}`;
    function loadPerf(){ return JSON.parse(localStorage.getItem(PERF_KEY(state.user))||'{}'); }
    function savePerf(p){ localStorage.setItem(PERF_KEY(state.user), JSON.stringify(p)); }
    function noteAttempt(q, correct, at, mode){
      if(mode==='review') return; // å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ã¯è¨˜éŒ²ã—ãªã„
      const p = loadPerf();
      const k = qKeyOf(q);
      const rec = p[k] || { id:q.id||null, type:q.type, jp:q.jp, en:q.en, unit:q.unit||null, attempts:[] };
      rec.attempts.push({ correct: !!correct, at });
      const cutoff = Date.now() - 30*24*3600*1000; // 30æ—¥ã§ãƒ­ãƒ¼ãƒ†
      rec.attempts = rec.attempts.filter(a=> new Date(a.at).getTime() >= cutoff);
      p[k]=rec; savePerf(p);
    }
    function updateQuestionStat(q, bucket){
      const elStreak = $('#stat-streak');
      const elAcc = $('#stat-accuracy');
      const elBucket = $('#stat-bucket');
      const elStage = $('#stat-stage');
      elBucket.textContent = bucket ? `ãƒã‚±ãƒƒãƒˆ: ${bucket}` : 'ãƒã‚±ãƒƒãƒˆ: --';
      elStage.textContent = 'ãƒ©ãƒ³ã‚¯: --';
      if(!state.user || !q.id){
        elStreak.textContent='é€£ç¶šæ­£è§£: --';
        elAcc.textContent='æ­£è§£ç‡: --';
        return;
      }
      fetch(`/api/stats?user=${encodeURIComponent(state.user)}&id=${encodeURIComponent(q.id)}&subject=${encodeURIComponent(SUBJECT)}`, {cache:'no-store'})
        .then(res=>res.ok?res.json():null)
        .then(data=>{
          if(!data){
            elStreak.textContent='é€£ç¶šæ­£è§£: --';
            elAcc.textContent='æ­£è§£ç‡: --';
            elStage.textContent='ãƒ©ãƒ³ã‚¯: --';
            return;
          }
          const ans=data.answered||0; const ok=data.correct||0;
          elStreak.textContent = `é€£ç¶šæ­£è§£: ${data.streak||0}`;
          elAcc.textContent = ans? `æ­£è§£ç‡: ${Math.round((ok/ans)*100)}% (${ok}/${ans})` : 'æ­£è§£ç‡: --';
          elStage.textContent = data.stage ? `ãƒ©ãƒ³ã‚¯: ${data.stage}` : 'ãƒ©ãƒ³ã‚¯: --';
        })
        .catch(()=>{
          elStreak.textContent='é€£ç¶šæ­£è§£: --';
          elAcc.textContent='æ­£è§£ç‡: --';
          elStage.textContent='ãƒ©ãƒ³ã‚¯: --';
        });
    }
    function weakCandidates(windowDays){
      const p = loadPerf();
      const cut = Date.now() - (windowDays*24*3600*1000);
      const list = [];
      const d = deck();
      for(const q of d){
        const k = qKeyOf(q);
        const rec = p[k];
        if(!rec || !rec.attempts || rec.attempts.length===0) continue;
        const arr = rec.attempts.filter(a=> new Date(a.at).getTime() >= cut);
        if(arr.length===0) continue;
        const wrong = arr.filter(a=>!a.correct).length;
        const acc = (arr.length - wrong)/arr.length;
        list.push({ q, acc, attempts: arr.length, wrong, lastAt: arr[arr.length-1].at });
      }
      // ä½æ­£ç­”ç‡ â†’ è©¦è¡Œå›æ•°å¤š â†’ æœ€è¿‘ ã®é †
      list.sort((a,b)=> (a.acc - b.acc) || (b.attempts - a.attempts) || (new Date(b.lastAt)-new Date(a.lastAt)) );
      return list;
    }
    function buildOrderWeak(windowDays=7){
      const stats = weakCandidates(windowDays);
      if(stats.length===0) return [];
      const pick = stats.slice(0, Math.min(state.totalPerSet, stats.length)).map(s=>s.q);
      window.__WEAK_DECK__ = pick;
      return pick.map((_,i)=>i);
    }

    async function startSet(){
      try{ await ensureQuestions(); }catch(e){ alert(e.message||e); return; }
      const fullDeck = deckByType(state.qType);
      if(!fullDeck.length){ alert(`ã“ã®å‡ºé¡Œã‚¿ã‚¤ãƒ—ã®å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚/data/${SUBJECT}/questions.json ã‚’ã”ç¢ºèªãã ã•ã„ã€‚`); show('setup'); return; }
      const filteredDeck = deck();
      if(state.mode==='normal' && !filteredDeck.length){
        alert('é¸æŠã—ãŸãƒ¬ãƒ™ãƒ«ï¼ãƒ¦ãƒ‹ãƒƒãƒˆã®æ¡ä»¶ã«åˆã†å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚æ¡ä»¶ã‚’è¦‹ç›´ã—ã¦ãã ã•ã„ã€‚');
        show('setup');
        return;
      }
      state.qIndex=0; state.correct=0; state.wrong=0; state.answered=[]; state.reviewed=[]; state.graded=false;
      $('#stat-correct').textContent='0'; $('#stat-wrong').textContent='0';
      if(state.mode==='review'){
        const ord = buildOrderFromWrong(state.reviewStrategy||'all');
        if(ord.length===0){ alert('å¾©ç¿’ã™ã‚‹å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšã¯é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§é–“é•ã„ã‚’ãŸã‚ã¾ã—ã‚‡ã†ã€‚'); show('setup'); return; }
        state.order = ord.map(i=>({idx:i, bucket:null, streak:0}));
      }else if(state.mode==='weak'){
        const ord = buildOrderWeak(state.weakWindowDays||7);
        if(ord.length===0){ alert('å¼±ç‚¹å€™è£œãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆæœ€è¿‘ã®ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ï¼‰ã€‚é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§è§£ã„ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å¢—ã‚„ã—ã¾ã—ã‚‡ã†ã€‚'); show('setup'); return; }
        state.order = ord.map(i=>({idx:i, bucket:null, streak:0}));
      }else{
        state.order = await buildOrderFromBank();
      }
      show('quiz'); startTimer(); renderQuestion();
    }

    /********** å‡ºé¡Œï¼†UI **********/
    function getCurrentQuestion(){
      const entry = state.order[state.qIndex];
      const idx = entry.idx;
      if(state.mode==='review') return window.__REVIEW_DECK__[idx];
      if(state.mode==='weak') return window.__WEAK_DECK__[idx];
      return deck()[idx];
    }

    function startTimer(){ state.startedAt=Date.now(); if(state.timerId) clearInterval(state.timerId); state.timerId=setInterval(()=>{ const sec=Math.floor((Date.now()-state.startedAt)/1000); $('#timer').textContent=`â± ${fmtTime(sec)}`; }, 250); }
    function stopTimer(){ if(state.timerId){ clearInterval(state.timerId); state.timerId=null; } }

    function renderQuestion(){
      const entry = state.order[state.qIndex];
      const q = getCurrentQuestion();
      updateQuestionStat(q, entry.bucket);
      state.graded = false;
      $('#status').textContent = `Q ${state.qIndex+1}/${state.order.length}${state.mode==='review'?'ï¼ˆå¾©ç¿’ï¼‰':''}`;
      $('#explain').textContent='';

      if(state.qType==='reorder'){
        $('#ui-reorder').style.display='block';
        $('#ui-vocab').style.display='none';
        const basePrompt = q.jp || '<span class="muted">èªé †ã‚’ä¸¦ã¹æ›¿ãˆã¾ã—ã‚‡ã†</span>';
        $('#prompt').innerHTML = basePrompt;
        $('#btn-hint').disabled = !q.tip;
        const target=$('#target'); const bank=$('#bank'); target.innerHTML=''; bank.innerHTML='';
        let chunks = q.chunks.slice();
        if(entry.streak >= HARD_STREAK && q.wrong && q.wrong.length>0){
          const w = q.wrong[Math.floor(Math.random()*q.wrong.length)];
          chunks = chunks.concat(w);
        }
        chunks = shuffle(chunks);
        chunks.forEach((c,i)=>{
          const chip=document.createElement('button'); chip.className='chip'; chip.setAttribute('data-text',c); chip.textContent=`${i+1}. ${c}`;
          chip.onclick=()=>placeChip(chip); bank.appendChild(chip);
          chip.draggable=true; chip.ondragstart=e=>{ e.dataTransfer.setData('text/plain', c); chip.classList.add('dragging'); };
          chip.ondragend=()=>chip.classList.remove('dragging');
        });
        $('#target').ondragover=e=>{ e.preventDefault(); };
        $('#target').ondrop=e=>{ e.preventDefault(); const text=e.dataTransfer.getData('text/plain'); const src=[...$$('#bank .chip')].find(ch=>ch.getAttribute('data-text')===text && !ch.classList.contains('used')); if(src) placeChip(src); };
        $('#btn-next').disabled = true;
      } else {
        $('#ui-reorder').style.display='none';
        $('#ui-vocab').style.display='block';
        $('#prompt').innerHTML = `æ„å‘³: <b>${q.jp}</b>`;
        $('#vocab-tip').innerHTML = '';
        $('#btn-hint').disabled = !q.tip;
        const inp = $('#vocab-input'); inp.value=''; inp.focus();
        $('#btn-next').disabled = false; // å…¥åŠ›ã ã‘ãªã®ã§æ¬¡ã¸ãƒœã‚¿ãƒ³ã¯å¸¸ã«æŠ¼ã›ã‚‹ï¼ˆæ¡ç‚¹ã¯1å›ï¼‰
      }
    }

    function showHint(){
      const q = getCurrentQuestion();
      if(!q.tip) return;
      if(state.qType==='reorder'){
        const base = q.jp || '<span class="muted">èªé †ã‚’ä¸¦ã¹æ›¿ãˆã¾ã—ã‚‡ã†</span>';
        $('#prompt').innerHTML = `${base}<br><span class="muted">ãƒ’ãƒ³ãƒˆ: ${q.tip}</span>`;
      } else {
        $('#vocab-tip').innerHTML = `ãƒ’ãƒ³ãƒˆ: ${q.tip}`;
      }
    }

    function placeChip(chip){ if(chip.classList.contains('used')) return; chip.classList.add('used'); const btn=document.createElement('button'); btn.className='chip'; btn.textContent=chip.getAttribute('data-text'); btn.onclick=()=>{ btn.remove(); chip.classList.remove('used'); updateNextState(); }; $('#target').appendChild(btn); updateNextState(); }
    function undo(){ if(state.qType!=='reorder') return; const t=$$('#target .chip'); const last=t[t.length-1]; if(!last) return; const text=last.textContent; last.remove(); const bankChip=[...$$('#bank .chip')].find(c=>c.getAttribute('data-text')===text); if(bankChip) bankChip.classList.remove('used'); updateNextState(); }
    function clearAnswer(){ if(state.qType==='reorder'){ $$('#target .chip').forEach(n=>n.remove()); $$('#bank .chip').forEach(n=>n.classList.remove('used')); updateNextState(); } else { $('#vocab-input').value=''; $('#vocab-input').focus(); } }

    function currentAnswer(){ if(state.qType==='reorder'){ return [...$('#target').children].map(x=>x.textContent).join(' ');} return $('#vocab-input').value||''; }
    function updateNextState(){ if(state.qType==='reorder'){ $('#btn-next').disabled = state.graded ? false : true; } }

    function buildFeedbackDetail(q, includeTip=false){
      const lines = [];
      if(q.explain) lines.push(q.explain);
      if(includeTip && q.tip) lines.push(q.tip);
      if(lines.length===0) return '';
      return '<br>' + lines.map(text=>`<span class="muted">${text}</span>`).join('<br>');
    }

    function formatCorrectAnswers(list){
      const answers = (Array.isArray(list)? list : [list]).filter(Boolean);
      if(!answers.length) return '<span class="muted">ï¼ˆæ­£è§£æœªè¨­å®šï¼‰</span>';
      if(answers.length===1) return `<b>${answers[0]}</b>`;
      return answers.map(ans=>`<b>${ans}</b>`).join('<br><span class="muted">ã¾ãŸã¯</span> ');
    }

    /********** æ¡ç‚¹ãƒ»é€²è¡Œ **********/
    function checkAnswer(){
      if(state.graded) return; // äºŒé‡åŠ ç®—é˜²æ­¢
      const q = getCurrentQuestion();

      const answerList = (Array.isArray(q.answers) && q.answers.length) ? q.answers : [q.en];
      let ans, correct;
      if(state.qType==='reorder'){
        const keepPunc = true; // ä¸¦ã³æ›¿ãˆã§ã¯æ–‡æœ«è¨˜å·ã‚’ä¿æŒã™ã‚‹
        const normalizedAns = normalizeEndPunc(normalizeSpaces(currentAnswer()), keepPunc);
        ans = normalizedAns? normalizedAns.charAt(0).toUpperCase()+normalizedAns.slice(1) : normalizedAns;
        const normalizedAnswers = answerList.map(a=>normalizeEndPunc(normalizeSpaces(a), keepPunc));
        const normalizedAnsLower = typeof normalizedAns === 'string' ? normalizedAns.toLowerCase() : normalizedAns;
        const normalizedAnswersLower = normalizedAnswers.map(a=>typeof a === 'string' ? a.toLowerCase() : a);
        correct = normalizedAnswersLower.includes(normalizedAnsLower);
      } else { // vocab
        ans = normalizeWord(currentAnswer());
        const normalizedAnswers = answerList.map(a=>normalizeWord(a));
        correct = normalizedAnswers.includes(ans);
      }

      const record = {
        type: state.qType,
        id: q.id||null,
        unit: q.unit||null,
        userAnswer: ans,
        correct,
        setIndex: state.setIndex, qIndex: state.qIndex, mode: (state.mode||'normal'),
        at: nowISO()
      };

      if(correct){
        state.correct++; $('#stat-correct').textContent = state.correct;
        const detail = buildFeedbackDetail(q, false);
        $('#explain').innerHTML = `âœ… æ­£è§£ï¼ <span class="muted">${ans}</span>${detail}`;
        removeFromWrongIfMatched({id:q.id, jp:q.jp, en:q.en});
      } else {
        state.wrong++; $('#stat-wrong').textContent = state.wrong;
        const detail = buildFeedbackDetail(q, true);
        const answersMarkup = formatCorrectAnswers(answerList);
        $('#explain').innerHTML = state.qType==='reorder'
          ? `âŒ ä¸æ­£è§£ã€‚ æ­£è§£: ${answersMarkup}${detail}`
          : `âŒ ä¸æ­£è§£ã€‚ æ­£è§£: ${answersMarkup}${detail}`;
        // å¾©ç¿’ç”¨ã«ã¯è©³ç´°ä¿æŒ
        addWrongLocal({ type:state.qType, id:q.id||null, unit:q.unit||null, level:q.level||DEFAULT_LEVEL, jp:q.jp, en:q.en, chunks:q.chunks, tip:q.tip||'', explain:q.explain||'', userAnswer: ans, at: record.at });
      }

      (state.mode==='review'? state.reviewed : state.answered).push(record);
      noteAttempt(q, correct, record.at, state.mode);
      updateQuestionStat(q, state.order[state.qIndex].bucket);
      state.graded = true;
      $('#btn-next').disabled = false;
    }

    function nextQuestion(){
      if(!state.graded) checkAnswer();
      state.qIndex++;
      if(state.qIndex >= state.order.length){ finishSet(); }
      else { renderQuestion(); }
    }

    function finishSet(){
      stopTimer();
      const total = state.order.length;
      const accuracy = total? Math.round((state.correct/total)*100):0;
      const seconds = Math.floor((Date.now()-state.startedAt)/1000);
      $('#summary').innerHTML = `æ­£è§£ <b>${state.correct}</b> / ${total}ï¼ˆ<b>${accuracy}%</b>ï¼‰ãƒ»æ‰€è¦æ™‚é–“ ${Math.floor(seconds/60)}åˆ†${seconds%60}ç§’`;
      show('finished');

      // --- ã“ã®ã‚»ãƒƒãƒˆã®èª¤ç­”ã ã‘ã‚’æŠ½å‡ºã—ã¦ãƒœã‚¿ãƒ³ã«æ¸¡ã™ ---
      const srcDeck = (state.mode==='review') ? window.__REVIEW_DECK__
                    : (state.mode==='weak')  ? window.__WEAK_DECK__
                    : deck();

      // è§£ç­”è¨˜éŒ²ï¼ˆé€šå¸¸ or å¾©ç¿’ï¼‰ã® qIndex ã¯ã€Œstate.order ä¸Šã®ä½ç½®ã€
      const records = (state.mode==='review') ? state.reviewed : state.answered;
      const missedObjs = records
        .filter(r=>!r.correct)
        .map(r=>{
          const idxInSrc = state.order[r.qIndex].idx;
          return srcDeck[idxInSrc];
        })
        .filter(Boolean);

      // çŠ¶æ…‹ã«ä¿æŒã—ã¦ã€ãƒœã‚¿ãƒ³è¡¨ç¤ºã‚’æ›´æ–°
      state.missedSetDeck = missedObjs;
      const btnReviewThis = document.getElementById('btn-review-thisset');
      if(btnReviewThis){
        const n = missedObjs.length;
        btnReviewThis.disabled = (n===0);
        btnReviewThis.textContent = n
          ? `â—ã“ã®ã‚»ãƒƒãƒˆã®ã¾ã¡ãŒã„ã§å¾©ç¿’ï¼ˆ${n}å•ï¼‰`
          : `â—ã“ã®ã‚»ãƒƒãƒˆã®ã¾ã¡ãŒã„ã§å¾©ç¿’ï¼ˆ0å•ï¼‰`;
      }

      const wireAnswered = state.answered.map(({type,id,unit,userAnswer,correct,setIndex,qIndex,mode,at})=>({type,id,unit,userAnswer,correct,setIndex,qIndex,mode,at}));
      const wireReviewed = state.reviewed.map(({type,id,unit,userAnswer,correct,setIndex,qIndex,mode,at})=>({type,id,unit,userAnswer,correct,setIndex,qIndex,mode,at}));
      const wireCorrect  = wireAnswered.filter(x=>x.correct);
      const wireMissed   = wireAnswered.filter(x=>!x.correct);
      const wireReviewMissed = wireReviewed.filter(x=>!x.correct);

      const sessionWire = {
        user: state.user,
        setIndex: state.setIndex,
        mode: state.mode||'normal',
        qType: state.qType,
        total,
        correct: state.correct,
        wrong: total - state.correct,
        accuracy,
        seconds,
        endedAt: nowISO(),
        answered: wireAnswered,
        correctItems: wireCorrect,
        missed: wireMissed,
        reviewed: wireReviewed,
        reviewMissed: wireReviewMissed
      };

      // ãƒ­ãƒ¼ã‚«ãƒ«å±¥æ­´ã¯ã‚µãƒãƒªã®ã¿ï¼ˆè»½é‡ï¼‰
      pushHistory({ user: state.user, setIndex: state.setIndex, mode: state.mode||'normal', qType: state.qType, total, correct: state.correct, wrong: total-state.correct, accuracy, seconds, endedAt: sessionWire.endedAt });

      const saveEl = document.getElementById('save-status');
      const url = state.endpoint || DEFAULT_ENDPOINT;
      if(url){
        saveEl.textContent = 'çµæœé€ä¿¡: é€ä¿¡ä¸­â€¦';
        const payload = { ...sessionWire, subject: SUBJECT };
        console.log('[POST] results =>', url, payload);
        postJSON(url, payload).then(r=>{
          if(r.ok){ saveEl.innerHTML = '<span class="ok">çµæœé€ä¿¡: æˆåŠŸ</span>'; }
          else { saveEl.innerHTML = `<span class=\"ng\">çµæœé€ä¿¡: å¤±æ•—</span> ${r.status||r.error||''}`; }
        });
      } else {
        saveEl.textContent = 'çµæœé€ä¿¡: URLæœªè¨­å®šï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã®ã¿ï¼‰';
      }
    }

    /********** ã‚¤ãƒ™ãƒ³ãƒˆ **********/
    document.getElementById('btn-start').onclick=async ()=>{
      try{
        state.user=(document.getElementById('learner').value||'guest').trim()||'guest';
        document.getElementById('user-pill').textContent=`ğŸ‘¤ ${state.user}`;
        state.totalPerSet=Math.max(3,Math.min(20,parseInt(document.getElementById('count').value||5,10)));
        state.endpoint=DEFAULT_ENDPOINT;
        state.setIndex=0; state.mode='normal'; state.qType=document.getElementById('qtype').value||'reorder';
        const levelSel=document.getElementById('level-filter');
        if(levelSel){
          state.levelMax = normalizeLevel(levelSel.value||DEFAULT_LEVEL);
          levelSel.value = state.levelMax;
        }
        const unitSel=document.getElementById('unit-filter');
        if(unitSel){
          const selected=(unitSel.value||'').trim();
          if(BANK_REORDER.length || BANK_VOCAB.length || !state.unitFilter){
            state.unitFilter=selected;
          }
        }
        rememberSettings();
        await startSet();
      }catch(e){ alert('é–‹å§‹ã§ãã¾ã›ã‚“: '+(e.message||e)); }
    };

    document.getElementById('btn-review-thisset').onclick = async ()=>{
      const deck = (state.missedSetDeck||[]).map(q=>({ ...q }));
      await startSetCustom(deck);
    };

    // å¼±ç‚¹å¯¾ç­–ï¼ˆéå»7æ—¥ï¼‰
    document.getElementById('btn-weak').onclick=async ()=>{
      try{
        state.user=(document.getElementById('learner').value||'guest').trim()||'guest';
        document.getElementById('user-pill').textContent=`ğŸ‘¤ ${state.user}`;
        state.totalPerSet=Math.max(3,Math.min(20,parseInt(document.getElementById('count').value||5,10)));
        state.endpoint=DEFAULT_ENDPOINT;
        state.setIndex=0; state.mode='weak'; state.qType=document.getElementById('qtype').value||'reorder';
        const levelSel=document.getElementById('level-filter');
        if(levelSel){
          state.levelMax = normalizeLevel(levelSel.value||DEFAULT_LEVEL);
          levelSel.value = state.levelMax;
        }
        const unitSel=document.getElementById('unit-filter');
        if(unitSel){
          const selected=(unitSel.value||'').trim();
          if(BANK_REORDER.length || BANK_VOCAB.length || !state.unitFilter){
            state.unitFilter=selected;
          }
        }
        rememberSettings();
        await startSet();
      }catch(e){ alert('å¼±ç‚¹å¯¾ç­–ã‚’é–‹å§‹ã§ãã¾ã›ã‚“: '+(e.message||e)); }
    };
   
    // å…¥åŠ›æ¬„å¤‰æ›´ã§å³ä¿å­˜ï¼‹ã‚µã‚¸ã‚§ã‚¹ãƒˆæ›´æ–°
    document.getElementById('learner').addEventListener('change', (e)=>{
      const v=(e.target.value||'').trim(); if(!v) return;
      state.user=v; document.getElementById('user-pill').textContent=`ğŸ‘¤ ${v}`;
      rememberSettings();
    });
    document.getElementById('unit-filter').addEventListener('change', (e)=>{
      const v=(e.target.value||'').trim();
      state.unitFilter=v;
      rememberSettings();
    });
    document.getElementById('level-filter').addEventListener('change', (e)=>{
      const selected = normalizeLevel(e.target.value||DEFAULT_LEVEL);
      state.levelMax = selected;
      const levelSel = document.getElementById('level-filter');
      if(levelSel) levelSel.value = selected;
      renderUnitFilterOptions();
      const unitSel = document.getElementById('unit-filter');
      if(unitSel){ state.unitFilter = (unitSel.value||'').trim(); }
      rememberSettings();
    });
    document.getElementById('qtype').addEventListener('change', async (e)=>{
      const v=(e.target.value||'').trim(); if(!v) return;
      state.qType=v;
      state.unitFilter = getRememberedUnitFilter(state.qType);
      try{
        await ensureQuestions();
      }catch(err){
        console.error('ensureQuestions failed', err);
        alert('å•é¡Œã®èª­ã¿è¾¼ã¿ã«å¤±æ•—: '+(err.message||err));
      }
      renderUnitFilterOptions();
      const sel=document.getElementById('unit-filter');
      if(sel){ state.unitFilter=(sel.value||'').trim(); }
      rememberSettings();
    });

    document.getElementById('btn-check').onclick=checkAnswer; document.getElementById('btn-next').onclick=nextQuestion; document.getElementById('btn-undo').onclick=undo; document.getElementById('btn-clear').onclick=clearAnswer; document.getElementById('btn-clear-vocab').onclick=()=>{ $('#vocab-input').value=''; $('#vocab-input').focus(); }; document.getElementById('btn-hint').onclick=showHint;
    document.getElementById('btn-speak').onclick=()=>{
      const q=getCurrentQuestion();
      if(!q) return;
      const text = (Array.isArray(q.answers) && q.answers.length) ? q.answers[0] : q.en;
      const u=new SpeechSynthesisUtterance(text);
      u.lang='en-US';
      u.rate=1.0;
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    };

    // å®Œäº†ç”»é¢ã®é·ç§»
      document.getElementById('btn-nextset').onclick=async ()=>{
        try{
          state.setIndex++;
          if(state.mode==='review'){ state.mode='normal'; }
          await startSet();
        }catch(e){
          alert('æ¬¡ã‚»ãƒƒãƒˆã‚’é–‹å§‹ã§ãã¾ã›ã‚“: '+(e.message||e));
        }
      };
    document.getElementById('btn-dashboard').onclick=()=>{ 
      try{ 
        const u = encodeURIComponent(state.user||'');
        window.location.href = `/admin?user=${u}`;
      }catch(e){ 
        alert('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸ç§»å‹•ã§ãã¾ã›ã‚“: '+(e.message||e)); 
      } 
    };
    document.getElementById('btn-to-setup').onclick=()=>{ show('setup'); };

    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ï¼ˆEnterã§æ¡ç‚¹/æ¬¡ã¸ï¼‹iOSã§ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚’é–‰ã˜ã‚‹ï¼‰
    window.addEventListener('keydown',(e)=>{
      if(document.getElementById('quiz').style.display==='none') return;
      if(state.qType==='reorder'){
        if(e.key>='1' && e.key<='9'){ const idx=parseInt(e.key,10)-1; const chips=$$('#bank .chip'); const chip=chips[idx]; if(chip) placeChip(chip); }
        else if(e.key==='Backspace'){ e.preventDefault(); undo(); }
      }
      if(e.key==='Enter'){
        e.preventDefault();
        if(!state.graded){ checkAnswer(); }
        else { nextQuestion(); }
        if(document.activeElement && document.activeElement.blur){ document.activeElement.blur(); }
      }
    });

    // åˆæœŸ
    loadRememberedSettings();
    ensureQuestions().catch(err=>{ console.error('ensureQuestions failed at init', err); });
    show('setup');
  </script>
</body>
</html>
