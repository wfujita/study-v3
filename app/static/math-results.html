<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>数学演習の提出履歴</title>
  <style>
    :root{
      --bg:#0f172a;
      --card:#111827;
      --muted:#94a3b8;
      --text:#e5e7eb;
      --border:#1f2937;
      --accent:#3b82f6;
      --ok:#22c55e;
      --warn:#ef4444;
    }
    *{ box-sizing:border-box }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif }
    header{ position:sticky; top:0; background:rgba(17,24,39,.9); backdrop-filter:saturate(150%) blur(6px); border-bottom:1px solid var(--border); z-index:10 }
    .container{ width:min(1400px, calc(100vw - 48px)); margin:0 auto; padding:16px }
    header .container{ display:flex; align-items:center; gap:16px }
    main{ padding-top:0 }
    h1{ margin:0 }
    .muted{ color:var(--muted) }
    .pill{ display:inline-flex; gap:8px; align-items:center; padding:6px 12px; border-radius:999px; border:1px solid #334155; background:#0b1220; color:#cbd5e1; font-size:12px }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; margin:16px 0 }
    .grid{ display:grid; gap:16px }
    .grid.cols-3{ grid-template-columns:repeat(3,minmax(0,1fr)) }
    .grid.cols-2{ grid-template-columns:repeat(2,minmax(0,1fr)) }
    .grid.cols-1{ grid-template-columns:1fr }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end }
    .row.filters label{ display:flex; gap:6px; align-items:center; color:var(--muted); font-size:14px }
    .row.filters select,
    .row.filters input{ background:#0b1220; color:#e5e7eb; border:1px solid #334155; border-radius:10px; padding:8px 12px; font-size:15px }
    .row.filters input{ min-width:220px }
    .row.filters label span{ color:var(--muted); font-size:13px }
    .right{ margin-left:auto }
    table{ width:100%; border-collapse:collapse; font-size:14px }
    th,td{ padding:10px; border-bottom:1px solid #1f2937; vertical-align:top }
    th{ text-align:left; color:#cbd5e1; background:#0b1220; position:sticky; top:0 }
    tr:hover td{ background:#0b1220 }
    .center{ text-align:center }
    .ok{ color:var(--ok); font-weight:600 }
    .ng{ color:var(--warn); font-weight:600 }
    .stat{ background:#0b1220; border:1px solid #334155; border-radius:12px; padding:14px }
    .stat .label{ font-size:12px; color:var(--muted); letter-spacing:.05em }
    .stat .value{ font-size:26px; font-weight:700 }
    .badge{ display:inline-flex; align-items:center; justify-content:center; padding:2px 10px; border-radius:999px; border:1px solid #334155; background:#101c30; font-size:12px; font-weight:600; min-width:32px }
    .status{ margin:12px 0 0; font-size:13px }
    .status.error{ color:var(--warn) }
    .stage-grid{ display:grid; gap:16px; grid-template-columns:repeat(2,minmax(0,1fr)); align-items:start }
    .stage-col{ background:#0b1220; border:1px solid #334155; border-radius:12px; padding:14px; display:flex; flex-direction:column; max-height:360px }
    .stage-col h4{ margin:0 0 8px; font-size:15px; display:flex; align-items:center; justify-content:space-between }
    .stage-col h4 span{ font-size:12px; color:var(--muted) }
    .stage-col .stage-desc{ margin:0 0 10px; font-size:12px; color:var(--muted); line-height:1.5 }
    .stage-col .stage-scroll{ overflow:auto; flex:1 }
    .stage-col table{ font-size:13px; width:100%; border-collapse:collapse }
    .stage-col th,.stage-col td{ padding:8px; border-bottom:1px solid #1f2937; text-align:left }
    .stage-col .empty{ color:var(--muted); font-size:12px; padding:6px 0 }
    @media (max-width:1024px){
      .grid.cols-3{ grid-template-columns:repeat(2,minmax(0,1fr)) }
    }
    @media (max-width:768px){
      .container{ width:calc(100vw - 32px); padding:12px }
      header .container{ padding:12px }
      .row.filters{ flex-direction:column; align-items:stretch }
      .row.filters label,
      .row.filters select,
      .row.filters input,
      .row.filters .pill{ width:100% }
      .row.filters .pill{ justify-content:center; margin-left:0 }
      .grid.cols-3,
      .grid.cols-2{ grid-template-columns:1fr }
      .stage-grid{ grid-template-columns:1fr }
      .stage-col{ max-height:none }
      .stage-col .stage-scroll{ overflow:visible; max-height:none }
    }
    @media (max-width:640px){
      table{ border:0 }
      thead{ display:none }
      tbody{ display:grid; gap:12px }
      tr{ display:grid; grid-template-columns:minmax(0,1fr); gap:6px; padding:10px; border:1px solid #334155; border-radius:10px; background:#101726 }
      td{ border:none; padding:0; display:block }
      td::before{ content:attr(data-label); color:var(--muted); font-weight:600; font-size:11px; display:block; margin-bottom:4px; letter-spacing:.05em; text-transform:uppercase }
      .stage-col table{ border:0 }
      .stage-col thead{ display:none }
      .stage-col tbody{ display:grid; gap:10px }
      .stage-col tr{ display:grid; grid-template-columns:minmax(0,1fr); gap:6px; padding:10px; border:1px solid #334155; border-radius:10px; background:#101726 }
      .stage-col td{ border:none; padding:0; display:block }
      .stage-col td::before{ content:attr(data-label); color:var(--muted); font-weight:600; font-size:11px; display:block; margin-bottom:2px; text-transform:uppercase }
    }
  </style>
</head>
<body>
  <header>
    <div class="container row" style="margin:0 auto">
      <div>
        <h1>数学演習の提出履歴</h1>
        <div class="muted" style="font-size:13px">学習者別・難易度別の集計と最近の提出履歴を確認できます。</div>
      </div>
      <a href="/math.html" class="pill right">⬅ 演習ページへ戻る</a>
    </div>
  </header>
  <main class="container">
    <section class="card">
      <div class="row filters">
        <label>
          <span>ユーザ</span>
          <select id="user"></select>
        </label>
        <label>
          <span>難易度</span>
          <select id="difficulty">
            <option value="all">（すべて）</option>
            <option value="normal">標準</option>
            <option value="hard">難問</option>
          </select>
        </label>
        <label style="flex:1 1 200px">
          <span>検索</span>
          <input id="search" placeholder="問題IDまたは本文を検索" />
        </label>
        <span class="pill right" id="last-updated">更新: --</span>
      </div>
      <p id="status" class="status muted" style="display:none">読み込み中です…</p>
    </section>

    <section class="grid cols-3">
      <div class="stat">
        <div class="label">提出数</div>
        <div class="value" id="st-total">0</div>
      </div>
      <div class="stat">
        <div class="label">正解数</div>
        <div class="value" id="st-correct">0</div>
      </div>
      <div class="stat">
        <div class="label">平均正答率</div>
        <div class="value" id="st-acc">0%</div>
      </div>
    </section>

    <section class="grid cols-2">
      <div class="card">
        <h3 style="margin:0 0 12px">学習者別成績</h3>
        <div style="max-height:320px; overflow:auto">
          <table id="tbl-users">
            <thead>
              <tr>
                <th style="width:12%" class="center">順位</th>
                <th style="width:30%">学習者</th>
                <th style="width:16%" class="center">解答数</th>
                <th style="width:16%" class="center">正解数</th>
                <th style="width:16%" class="center">正答率</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="card">
        <h3 style="margin:0 0 12px">難易度別の成績</h3>
        <div style="max-height:260px; overflow:auto">
          <table id="tbl-difficulty">
            <thead>
              <tr>
                <th style="width:30%">難易度</th>
                <th style="width:18%" class="center">解答数</th>
                <th style="width:18%" class="center">正解数</th>
                <th style="width:18%" class="center">正答率</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="card" id="sec-stages" style="display:none">
      <h3 style="margin:0 0 12px">ステージ別の問題一覧</h3>
      <p class="muted" style="font-size:13px; margin:0 0 12px">ユーザを選択すると、その学習者のステージごとの問題リストが表示されます。</p>
      <div class="stage-grid" id="stage-grid"></div>
    </section>

    <section class="card">
      <h3 style="margin:0 0 12px">問題別の成績</h3>
      <div style="max-height:340px; overflow:auto">
        <table id="tbl-questions">
          <thead>
            <tr>
              <th style="width:14%">ID</th>
              <th style="width:40%">問題</th>
              <th style="width:10%" class="center">難易度</th>
              <th style="width:12%" class="center">解答数</th>
              <th style="width:12%" class="center">正解数</th>
              <th style="width:12%" class="center">正答率</th>
              <th style="width:18%">最終提出</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="card">
      <h3 style="margin:0 0 12px">最近の提出（最大100件）</h3>
      <div style="max-height:340px; overflow:auto">
        <table id="tbl-recent">
          <thead>
            <tr>
              <th style="width:14%">提出日時</th>
              <th style="width:8%" class="center">正誤</th>
              <th style="width:12%">学習者</th>
              <th style="width:10%" class="center">難易度</th>
              <th style="width:24%">問題</th>
              <th style="width:16%">学習者の解答</th>
              <th style="width:16%">正答例</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    const SUBJECT = 'math';
    const DASHBOARD_ENDPOINT = '/api/math/dashboard';
    const REMEMBER_USER_KEY = 'math:lastUser';

    const params = new URLSearchParams(location.search);
    const storedUser = localStorage.getItem(REMEMBER_USER_KEY) || '';
    const paramUser = params.get('user');
    const initialUser = paramUser ? paramUser : (storedUser || '__all__');
    const initialDifficulty = ['normal','hard'].includes(params.get('difficulty')) ? params.get('difficulty') : 'all';
    const initialQuery = params.get('q') || '';

    let currentUser = initialUser || '__all__';
    let currentDifficulty = initialDifficulty || 'all';
    let currentQuery = initialQuery || '';

    const $ = (sel)=> document.querySelector(sel);
    const $$ = (sel)=> Array.from(document.querySelectorAll(sel));

    const fmt = (value)=>{
      const num = Number(value);
      if(!Number.isFinite(num)) return '0';
      return new Intl.NumberFormat('ja-JP').format(num);
    };
    const pct = (value)=>{
      const num = Number(value);
      if(!Number.isFinite(num)) return '0%';
      return `${(Math.round(num*10)/10).toFixed(1)}%`;
    };
    const escapeHtml = (value='')=> String(value)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
    const formatDateTime = (value)=>{
      if(!value) return '―';
      try{
        const dt = new Date(value);
        if(Number.isNaN(dt.getTime())) return value;
        return new Intl.DateTimeFormat('ja-JP',{ dateStyle:'medium', timeStyle:'short' }).format(dt);
      }catch(err){
        return value;
      }
    };
    const difficultyLabel = (value)=> value==='hard' ? '難問' : '標準';

    const STAGE_DESCRIPTIONS = {
      A: '最終正解から30日以上空いても正解できた問題です。',
      B: '最終正解から7日以上空いても正解できた問題です。',
      C: '最終正解から3日以上空いても正解できた問題です。',
      D: '最終正解から3日未満の状態で、次の昇格条件は3日以上空けて正解することです。',
      E: '学習し始めたばかり、または不正解直後の状態の問題です。'
    };

    const statusEl = $('#status');
    const lastUpdatedEl = $('#last-updated');
    const userSelect = $('#user');
    const difficultySelect = $('#difficulty');
    const searchInput = $('#search');

    if(userSelect) userSelect.value = currentUser;
    if(difficultySelect) difficultySelect.value = currentDifficulty;
    if(searchInput) searchInput.value = currentQuery;

    function setStatus(message, type='info'){
      if(!statusEl) return;
      if(!message){
        statusEl.textContent='';
        statusEl.style.display='none';
        statusEl.className='status muted';
        return;
      }
      statusEl.textContent=message;
      statusEl.style.display='';
      statusEl.className = 'status ' + (type==='error' ? 'error' : 'muted');
    }

    async function getJSON(path, params={}){
      const query = new URLSearchParams(params);
      const url = `${path}?${query.toString()}`;
      const res = await fetch(url, { cache:'no-store' });
      if(!res.ok) throw new Error(`fetch ${path} ${res.status}`);
      return res.json();
    }

    function rememberUser(){
      if(currentUser && currentUser !== '__all__'){
        localStorage.setItem(REMEMBER_USER_KEY, currentUser);
      }else{
        localStorage.removeItem(REMEMBER_USER_KEY);
      }
    }

    function syncUrl(){
      const qs = new URLSearchParams();
      if(currentUser && currentUser !== '__all__') qs.set('user', currentUser);
      if(currentDifficulty && currentDifficulty !== 'all') qs.set('difficulty', currentDifficulty);
      if(currentQuery) qs.set('q', currentQuery);
      const newUrl = qs.toString()? `?${qs.toString()}` : location.pathname;
      history.replaceState(null, '', newUrl);
    }

    function renderSummary(totals={}){
      $('#st-total').textContent = fmt(totals.answered || 0);
      $('#st-correct').textContent = fmt(totals.correct || 0);
      const acc = Number.isFinite(Number(totals.accuracy)) ? totals.accuracy : (totals.answered ? (totals.correct/totals.answered*100) : 0);
      $('#st-acc').textContent = pct(acc || 0);
    }

    function renderRankBadge(value, fallback){
      if(typeof value === 'string' && value.trim()) return `<span class="badge">${escapeHtml(value.trim())}</span>`;
      if(typeof value === 'number' && Number.isFinite(value)) return `<span class="badge">${fmt(value)}</span>`;
      if(value && typeof value === 'object'){
        const label = value.label || value.text || value.name;
        if(typeof label === 'string' && label.trim()) return `<span class="badge">${escapeHtml(label.trim())}</span>`;
      }
      const num = Number.isFinite(fallback) ? fallback : 0;
      return `<span class="badge">${fmt(num)}</span>`;
    }

    function renderUsersTable(list){
      const body = $('#tbl-users tbody');
      if(!body) return;
      body.innerHTML='';
      (Array.isArray(list)? list:[]).forEach((item, index)=>{
        const tr = document.createElement('tr');
        const rankDisplay = renderRankBadge(item.rank, index+1);
        tr.innerHTML = `<td data-label="順位" class="center">${rankDisplay}</td>`+
                       `<td data-label="学習者">${escapeHtml(item.user || 'ゲスト')}</td>`+
                       `<td data-label="解答数" class="center">${fmt(item.answered || 0)}</td>`+
                       `<td data-label="正解数" class="center ok">${fmt(item.correct || 0)}</td>`+
                       `<td data-label="正答率" class="center">${pct(item.accuracy || 0)}</td>`;
        body.appendChild(tr);
      });
    }

    function renderDifficultyTable(list){
      const body = $('#tbl-difficulty tbody');
      if(!body) return;
      body.innerHTML='';
      const items = Array.isArray(list) && list.length ? list : [
        { difficulty:'normal', answered:0, correct:0, accuracy:0 },
        { difficulty:'hard', answered:0, correct:0, accuracy:0 }
      ];
      items.forEach(item=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td data-label="難易度">${difficultyLabel(item.difficulty)}</td>`+
                       `<td data-label="解答数" class="center">${fmt(item.answered || 0)}</td>`+
                       `<td data-label="正解数" class="center ok">${fmt(item.correct || 0)}</td>`+
                       `<td data-label="正答率" class="center">${pct(item.accuracy || 0)}</td>`;
        body.appendChild(tr);
      });
    }

    function renderStageBuckets(buckets={}, order=[]){
      const sec = $('#sec-stages');
      const grid = $('#stage-grid');
      if(!sec || !grid) return;
      if(!currentUser || currentUser === '__all__'){
        sec.style.display='none';
        grid.innerHTML='';
        return;
      }
      sec.style.display='';
      grid.innerHTML='';
      const stageOrder = Array.isArray(order) && order.length ? order : ['A','B','C','D','E'];
      stageOrder.forEach(stageName=>{
        const questions = Array.isArray(buckets[stageName])? buckets[stageName]:[];
        const col = document.createElement('div');
        col.className='stage-col';
        const header = document.createElement('h4');
        header.innerHTML = `ステージ${stageName}<span>${fmt(questions.length)}件</span>`;
        col.appendChild(header);
        const desc = STAGE_DESCRIPTIONS[stageName];
        if(desc){
          const p = document.createElement('p');
          p.className='stage-desc';
          p.textContent = desc;
          col.appendChild(p);
        }
        const scroll = document.createElement('div');
        scroll.className='stage-scroll';
        if(!questions.length){
          scroll.innerHTML='<div class="empty">該当する問題がありません。</div>';
        }else{
          const table = document.createElement('table');
          table.innerHTML = '<thead><tr><th>ID</th><th>問題</th><th class="center">難易度</th><th class="center">正答率</th><th class="center">連続正解</th><th class="center">次回</th></tr></thead>';
          const body = document.createElement('tbody');
          questions.forEach(q=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `<td data-label="ID">${escapeHtml(q.id || '-')}</td>`+
                           `<td data-label="問題">${escapeHtml(q.prompt || '-')}</td>`+
                           `<td data-label="難易度" class="center">${q.difficulty? difficultyLabel(q.difficulty):''}</td>`+
                           `<td data-label="正答率" class="center">${pct(q.accuracy || 0)}</td>`+
                           `<td data-label="連続正解" class="center">${fmt(q.streak || 0)}</td>`+
                           `<td data-label="次回" class="center">${formatDateTime(q.nextDueAt)}</td>`;
            body.appendChild(tr);
          });
          table.appendChild(body);
          scroll.appendChild(table);
        }
        col.appendChild(scroll);
        grid.appendChild(col);
      });
    }

    function renderQuestionsTable(list){
      const body = $('#tbl-questions tbody');
      if(!body) return;
      body.innerHTML='';
      (Array.isArray(list)? list:[]).forEach(item=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td data-label="ID">${escapeHtml(item.id || '-')}</td>`+
                       `<td data-label="問題">${escapeHtml(item.prompt || '-')}</td>`+
                       `<td data-label="難易度" class="center">${difficultyLabel(item.difficulty)}</td>`+
                       `<td data-label="解答数" class="center">${fmt(item.answered || 0)}</td>`+
                       `<td data-label="正解数" class="center ok">${fmt(item.correct || 0)}</td>`+
                       `<td data-label="正答率" class="center">${pct(item.accuracy || 0)}</td>`+
                       `<td data-label="最終提出">${formatDateTime(item.lastAnsweredAt)}</td>`;
        if((item.wrong || 0) > 0){
          tr.style.background='rgba(239,68,68,0.08)';
        }
        body.appendChild(tr);
      });
    }

    function renderRecentTable(list){
      const body = $('#tbl-recent tbody');
      if(!body) return;
      body.innerHTML='';
      (Array.isArray(list)? list:[]).forEach(item=>{
        const ok = !!item.correct;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td data-label="提出日時">${formatDateTime(item.endedAt)}</td>`+
                       `<td data-label="正誤" class="center ${ok?'ok':'ng'}">${ok?'○':'×'}</td>`+
                       `<td data-label="学習者">${escapeHtml(item.user || 'ゲスト')}</td>`+
                       `<td data-label="難易度" class="center">${difficultyLabel(item.difficulty)}</td>`+
                       `<td data-label="問題">${escapeHtml(item.prompt || '-')}</td>`+
                       `<td data-label="学習者の解答">${escapeHtml(item.responseText || '―')}</td>`+
                       `<td data-label="正答例">${escapeHtml(item.acceptedText || '―')}</td>`;
        if(!ok){
          tr.style.background='rgba(239,68,68,0.08)';
        }
        body.appendChild(tr);
      });
    }

    function populateUserOptions(options){
      if(!userSelect) return;
      const available = new Set(['__all__']);
      userSelect.innerHTML='';
      const optAll = document.createElement('option');
      optAll.value='__all__';
      optAll.textContent='（すべて）';
      userSelect.appendChild(optAll);
      (Array.isArray(options)? options:[]).forEach(item=>{
        const value = item.user || '';
        const opt = document.createElement('option');
        opt.value = value;
        opt.textContent = `${value || 'ゲスト'}（${fmt(item.answered || 0)}件）`;
        userSelect.appendChild(opt);
        available.add(value);
      });
      if(!available.has(currentUser)){
        currentUser='__all__';
      }
      userSelect.value = currentUser;
    }

    async function refresh(){
      const requestedUser = userSelect? (userSelect.value || '__all__') : currentUser;
      const requestedDifficulty = difficultySelect? (difficultySelect.value || 'all') : currentDifficulty;
      const requestedQuery = searchInput? searchInput.value.trim() : currentQuery;
      currentUser = requestedUser;
      currentDifficulty = requestedDifficulty;
      currentQuery = requestedQuery;

      const query = { subject: SUBJECT };
      if(currentUser && currentUser !== '__all__') query.user = currentUser;
      if(currentDifficulty && currentDifficulty !== 'all') query.difficulty = currentDifficulty;
      if(currentQuery) query.q = currentQuery;

      try{
        setStatus('読み込み中です…', 'info');
        const data = await getJSON(DASHBOARD_ENDPOINT, query);
        populateUserOptions(data.userOptions || []);
        rememberUser();
        renderSummary(data.totals || {});
        renderUsersTable(data.userSummaries || []);
        renderDifficultyTable(data.difficultyStats || []);
        renderStageBuckets(data.stageBuckets || {}, data.stageOrder || []);
        renderQuestionsTable(data.questionStats || []);
        renderRecentTable(data.recentAttempts || []);
        if(lastUpdatedEl){
          const txt = data.lastUpdated ? formatDateTime(data.lastUpdated) : formatDateTime(new Date());
          lastUpdatedEl.textContent = `更新: ${txt}`;
        }
        const hasData = data.totals && Number(data.totals.answered || 0) > 0;
        if(hasData){
          setStatus('', 'info');
        }else{
          setStatus('該当する提出がありません。', 'info');
        }
        syncUrl();
      }catch(err){
        console.error(err);
        setStatus(`データの取得に失敗しました: ${err.message}`, 'error');
      }
    }

    if(userSelect){
      userSelect.addEventListener('change', refresh);
    }
    if(difficultySelect){
      difficultySelect.addEventListener('change', refresh);
    }
    if(searchInput){
      searchInput.addEventListener('input', ()=>{
        clearTimeout(window.__mathTimer);
        window.__mathTimer = setTimeout(refresh, 400);
      });
    }

    refresh();
  </script>
</body>
</html>
