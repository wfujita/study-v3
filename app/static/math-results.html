<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>数学演習の提出履歴</title>
  <style>
    :root{
      --bg:#0f172a;
      --card:#111827;
      --muted:#94a3b8;
      --text:#e5e7eb;
      --border:#1f2937;
      --accent:#3b82f6;
      --ok:#22c55e;
      --error:#ef4444;
    }
    *{box-sizing:border-box;}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif;}
    header{position:sticky;top:0;background:rgba(17,24,39,.9);backdrop-filter:saturate(150%) blur(6px);border-bottom:1px solid var(--border);z-index:10;}
    header .container{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:16px;width:min(1200px,calc(100vw-48px));margin:0 auto;}
    main{width:min(1200px,calc(100vw-48px));margin:0 auto;padding:16px;}
    h1{margin:0;}
    .muted{color:var(--muted);}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin:16px 0;}
    .grid{display:grid;gap:16px;}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr));}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr));}
    .grid.cols-1{grid-template-columns:1fr;}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end;}
    .row label{display:flex;flex-direction:column;gap:6px;font-size:14px;color:var(--muted);}
    select,input{background:#0b1220;color:var(--text);border:1px solid #334155;border-radius:10px;padding:8px 12px;font-size:15px;min-width:180px;}
    input::placeholder{color:#64748b;}
    button{background:var(--accent);color:#fff;border:1px solid var(--accent);border-radius:10px;padding:8px 16px;font-size:15px;cursor:pointer;}
    button.secondary{background:#1e293b;border-color:#1e293b;color:#cbd5e1;}
    button:disabled{opacity:.6;cursor:not-allowed;}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 12px;border-radius:999px;background:#0b1220;border:1px solid #334155;color:#cbd5e1;font-size:12px;}
    .right{margin-left:auto;}
    table{width:100%;border-collapse:collapse;font-size:14px;}
    th,td{padding:10px;border-bottom:1px solid #1f2937;vertical-align:top;text-align:left;}
    th{color:#cbd5e1;font-size:13px;text-transform:uppercase;letter-spacing:.05em;background:#101827;position:sticky;top:0;z-index:1;}
    tr:hover td{background:#0b1220;}
    .center{text-align:center;}
    .ok{color:var(--ok);font-weight:600;}
    .ng{color:var(--error);font-weight:600;}
    .table-scroll{max-height:360px;overflow:auto;border:1px solid #1f2937;border-radius:12px;background:#0b1220;}
    .table-scroll table{margin:0;}
    .empty{color:var(--muted);font-size:13px;margin:12px 0 0;}
    .stat-card{background:#0b1220;border:1px solid #334155;border-radius:14px;padding:16px;display:flex;flex-direction:column;gap:6px;}
    .stat-label{font-size:13px;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;}
    .stat-value{font-size:28px;font-weight:700;}
    .status{margin-top:12px;font-size:14px;}
    .status-error{color:var(--error);}

    @media (max-width:1024px){
      .grid.cols-3{grid-template-columns:repeat(2,minmax(0,1fr));}
    }
    @media (max-width:768px){
      header .container,main{width:calc(100vw-24px);padding:12px;}
      .grid.cols-2,.grid.cols-3{grid-template-columns:1fr;}
      .row{flex-direction:column;align-items:stretch;}
      .row label,select,input,button{width:100%;}
      .pill.right{margin-left:0;justify-content:center;}
      .table-scroll{max-height:none;}
    }
    @media (max-width:640px){
      th,td{display:block;padding:8px;}
      thead{display:none;}
      table{border:0;}
      tbody{display:grid;gap:12px;padding:12px;}
      tr{background:#0f172a;border:1px solid #1f2937;border-radius:12px;padding:8px;}
      td{border:none;}
      td::before{content:attr(data-label);display:block;font-size:12px;color:var(--muted);font-weight:600;margin-bottom:4px;text-transform:uppercase;letter-spacing:.05em;}
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div>
        <h1>数学演習の提出履歴</h1>
        <div class="muted" style="font-size:13px">学習者別・難易度別の集計と最近の提出履歴を確認できます。</div>
      </div>
      <a href="/math.html" class="pill">⬅ 演習ページへ戻る</a>
    </div>
  </header>
  <main>
    <section class="card">
      <div class="row filters">
        <label>
          <span>ユーザ</span>
          <select id="user"></select>
        </label>
        <label>
          <span>難易度</span>
          <select id="difficulty">
            <option value="all">（すべて）</option>
            <option value="normal">標準</option>
            <option value="hard">難問</option>
          </select>
        </label>
        <label style="flex:1 1 200px;min-width:220px;">
          <span>検索</span>
          <input id="search" placeholder="問題IDまたは本文を検索" />
        </label>
        <div style="display:flex;gap:8px;align-items:center;">
          <button id="btn-apply">絞り込み</button>
          <button id="btn-clear" class="secondary">クリア</button>
        </div>
        <span class="pill right" id="last-updated">更新: --</span>
      </div>
      <p id="status" class="status muted">読み込み中です…</p>
    </section>

    <section class="grid cols-3">
      <div class="stat-card">
        <div class="stat-label">提出数</div>
        <div class="stat-value" id="stat-total">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">正解数</div>
        <div class="stat-value" id="stat-correct">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">平均正答率</div>
        <div class="stat-value" id="stat-accuracy">0%</div>
      </div>
    </section>

    <section class="grid cols-2">
      <div class="card">
        <h3 style="margin:0 0 12px">学習者別の成績</h3>
        <div class="table-scroll">
          <table id="tbl-users">
            <thead>
              <tr>
                <th style="width:30%">学習者</th>
                <th style="width:18%" class="center">解答数</th>
                <th style="width:18%" class="center">正解数</th>
                <th style="width:18%" class="center">正答率</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <p id="users-empty" class="empty" style="display:none">該当する提出がありません。</p>
      </div>
      <div class="card">
        <h3 style="margin:0 0 12px">難易度別の成績</h3>
        <div class="table-scroll" style="max-height:260px;">
          <table id="tbl-difficulty">
            <thead>
              <tr>
                <th style="width:30%">難易度</th>
                <th style="width:18%" class="center">解答数</th>
                <th style="width:18%" class="center">正解数</th>
                <th style="width:18%" class="center">正答率</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="card">
      <h3 style="margin:0 0 12px">問題別の成績</h3>
      <div class="table-scroll">
        <table id="tbl-questions">
          <thead>
            <tr>
              <th style="width:14%">ID</th>
              <th style="width:40%">問題</th>
              <th style="width:10%" class="center">難易度</th>
              <th style="width:12%" class="center">解答数</th>
              <th style="width:12%" class="center">正解数</th>
              <th style="width:12%" class="center">正答率</th>
              <th style="width:16%">最終提出</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p id="questions-empty" class="empty" style="display:none">該当する提出がありません。</p>
    </section>

    <section class="card">
      <h3 style="margin:0 0 12px">最近の提出（最大100件）</h3>
      <div class="table-scroll">
        <table id="tbl-recent">
          <thead>
            <tr>
              <th style="width:18%">提出日時</th>
              <th style="width:10%" class="center">正誤</th>
              <th style="width:12%">学習者</th>
              <th style="width:10%" class="center">難易度</th>
              <th style="width:32%">問題</th>
              <th style="width:18%">学習者の解答</th>
              <th style="width:18%">正答例</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p id="recent-empty" class="empty" style="display:none">該当する提出がありません。</p>
    </section>
  </main>
  <script>
    const SUBJECT = 'math';
    const DASHBOARD_ENDPOINT = '/api/math/dashboard';
    const REMEMBER_USER_KEY = 'math:lastUser';

    const params = new URLSearchParams(location.search);
    const storedUser = localStorage.getItem(REMEMBER_USER_KEY) || '';
    const initialUser = params.get('user') || storedUser || '__all__';
    const initialDifficulty = params.get('difficulty') || 'all';
    const initialQuery = params.get('q') || '';

    const state = {
      selectedUser: initialUser,
      selectedDifficulty: initialDifficulty,
      searchQuery: initialQuery,
      loading: false,
      requestId: 0,
    };

    const $ = (sel) => document.querySelector(sel);
    const userSelect = $('#user');
    const difficultySelect = $('#difficulty');
    const searchInput = $('#search');
    const statusEl = $('#status');
    const lastUpdatedEl = $('#last-updated');

    if (searchInput) searchInput.value = state.searchQuery;
    if (difficultySelect) difficultySelect.value = ['normal','hard'].includes(state.selectedDifficulty) ? state.selectedDifficulty : 'all';

    function formatNumber(value){
      const num = Number(value);
      if(!Number.isFinite(num)) return '0';
      return new Intl.NumberFormat('ja-JP').format(num);
    }

    function formatPercent(value){
      const num = Number(value);
      if(!Number.isFinite(num)) return '0%';
      return `${num.toFixed(1)}%`;
    }

    function formatDateTime(value){
      if(!value) return '―';
      try{
        const dt = new Date(value);
        if(Number.isNaN(dt.getTime())) return value;
        return new Intl.DateTimeFormat('ja-JP', { dateStyle: 'medium', timeStyle: 'short' }).format(dt);
      }catch(err){
        return value;
      }
    }

    function displayUserName(value){
      if(!value) return 'ゲスト';
      const text = String(value).trim();
      if(!text) return 'ゲスト';
      const lower = text.toLowerCase();
      if(lower === 'guest' || lower === 'math') return 'ゲスト';
      return text;
    }

    function difficultyLabel(value){
      return value === 'hard' ? '難問' : '標準';
    }

    function setStatus(message, type='muted'){
      if(!statusEl) return;
      if(!message){
        statusEl.textContent = '';
        statusEl.className = 'status muted';
        statusEl.style.display = 'none';
        return;
      }
      statusEl.style.display = '';
      statusEl.textContent = message;
      statusEl.className = 'status ' + (type === 'error' ? 'status-error' : 'muted');
    }

    function syncUrl(){
      const qs = new URLSearchParams();
      if(state.selectedUser && state.selectedUser !== '__all__') qs.set('user', state.selectedUser);
      if(state.selectedDifficulty && state.selectedDifficulty !== 'all') qs.set('difficulty', state.selectedDifficulty);
      if(state.searchQuery) qs.set('q', state.searchQuery);
      const newUrl = qs.toString() ? `?${qs.toString()}` : location.pathname;
      history.replaceState(null, '', newUrl);
    }

    function rememberUser(){
      if(state.selectedUser && state.selectedUser !== '__all__'){
        localStorage.setItem(REMEMBER_USER_KEY, state.selectedUser);
      }else{
        localStorage.removeItem(REMEMBER_USER_KEY);
      }
    }

    function populateUserOptions(data){
      if(!userSelect) return;
      const current = state.selectedUser || '__all__';
      userSelect.innerHTML = '';
      const optAll = document.createElement('option');
      optAll.value = '__all__';
      optAll.textContent = '（すべて）';
      userSelect.appendChild(optAll);
      const options = Array.isArray(data.userOptions) ? data.userOptions : [];
      const values = new Set(['__all__']);
      options.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item.user || '';
        opt.textContent = displayUserName(item.user || '') + `（${formatNumber(item.answered || 0)}件）`;
        userSelect.appendChild(opt);
        values.add(opt.value);
      });
      const target = values.has(current) ? current : '__all__';
      userSelect.value = target;
      state.selectedUser = target;
    }

    function renderSummary(totals){
      $('#stat-total').textContent = formatNumber(totals.answered || 0);
      $('#stat-correct').textContent = formatNumber(totals.correct || 0);
      $('#stat-accuracy').textContent = formatPercent(totals.accuracy || 0);
    }

    function renderUsersTable(list){
      const body = $('#tbl-users tbody');
      const empty = $('#users-empty');
      if(!body) return;
      body.innerHTML = '';
      if(!Array.isArray(list) || !list.length){
        if(empty) empty.style.display = '';
        return;
      }
      list.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td data-label="学習者">${displayUserName(item.user)}</td>`+
                       `<td data-label="解答数" class="center">${formatNumber(item.answered || 0)}</td>`+
                       `<td data-label="正解数" class="center ok">${formatNumber(item.correct || 0)}</td>`+
                       `<td data-label="正答率" class="center">${formatPercent(item.accuracy || 0)}</td>`;
        body.appendChild(tr);
      });
      if(empty) empty.style.display = 'none';
    }

    function renderDifficultyTable(list){
      const body = $('#tbl-difficulty tbody');
      if(!body) return;
      body.innerHTML = '';
      const items = Array.isArray(list) && list.length ? list : [
        { difficulty: 'normal', answered: 0, correct: 0, accuracy: 0 },
        { difficulty: 'hard', answered: 0, correct: 0, accuracy: 0 },
      ];
      items.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td data-label="難易度">${difficultyLabel(item.difficulty)}</td>`+
                       `<td data-label="解答数" class="center">${formatNumber(item.answered || 0)}</td>`+
                       `<td data-label="正解数" class="center ok">${formatNumber(item.correct || 0)}</td>`+
                       `<td data-label="正答率" class="center">${formatPercent(item.accuracy || 0)}</td>`;
        body.appendChild(tr);
      });
    }

    function renderQuestionsTable(list){
      const body = $('#tbl-questions tbody');
      const empty = $('#questions-empty');
      if(!body) return;
      body.innerHTML = '';
      if(!Array.isArray(list) || !list.length){
        if(empty) empty.style.display = '';
        return;
      }
      list.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td data-label="ID">${item.id || '-'}</td>`+
                       `<td data-label="問題">${item.prompt || '-'}</td>`+
                       `<td data-label="難易度" class="center">${difficultyLabel(item.difficulty)}</td>`+
                       `<td data-label="解答数" class="center">${formatNumber(item.answered || 0)}</td>`+
                       `<td data-label="正解数" class="center ok">${formatNumber(item.correct || 0)}</td>`+
                       `<td data-label="正答率" class="center">${formatPercent(item.accuracy || 0)}</td>`+
                       `<td data-label="最終提出">${formatDateTime(item.lastAnsweredAt)}</td>`;
        if((item.wrong || 0) > 0){
          tr.style.background = 'rgba(239,68,68,0.08)';
        }
        body.appendChild(tr);
      });
      if(empty) empty.style.display = 'none';
    }

    function renderRecentTable(list){
      const body = $('#tbl-recent tbody');
      const empty = $('#recent-empty');
      if(!body) return;
      body.innerHTML = '';
      if(!Array.isArray(list) || !list.length){
        if(empty) empty.style.display = '';
        return;
      }
      list.forEach(item => {
        const tr = document.createElement('tr');
        const ok = !!item.correct;
        tr.innerHTML = `<td data-label="提出日時">${formatDateTime(item.endedAt)}</td>`+
                       `<td data-label="正誤" class="center ${ok ? 'ok' : 'ng'}">${ok ? '○' : '×'}</td>`+
                       `<td data-label="学習者">${displayUserName(item.user)}</td>`+
                       `<td data-label="難易度" class="center">${difficultyLabel(item.difficulty)}</td>`+
                       `<td data-label="問題">${item.prompt || '-'}</td>`+
                       `<td data-label="学習者の解答">${item.responseText || '―'}</td>`+
                       `<td data-label="正答例">${item.acceptedText || '―'}</td>`;
        if(!ok){
          tr.style.background = 'rgba(239,68,68,0.08)';
        }
        body.appendChild(tr);
      });
      if(empty) empty.style.display = 'none';
    }

    function renderDashboard(data){
      renderSummary(data.totals || {});
      renderUsersTable(data.userSummaries || []);
      renderDifficultyTable(data.difficultyStats || []);
      renderQuestionsTable(data.questionStats || []);
      renderRecentTable(data.recentAttempts || []);

      if(lastUpdatedEl){
        const txt = data.lastUpdated ? formatDateTime(data.lastUpdated) : '--';
        lastUpdatedEl.textContent = `更新: ${txt}`;
      }

      const hasData = (data.totals && data.totals.answered > 0);
      if(hasData){
        setStatus('');
      }else{
        setStatus('該当する提出がありません。', 'muted');
      }
    }

    function fetchDashboard(){
      setStatus('読み込み中です…', 'muted');
      state.loading = true;
      const requestId = (state.requestId || 0) + 1;
      state.requestId = requestId;
      const qs = new URLSearchParams();
      qs.set('subject', SUBJECT);
      if(state.selectedUser && state.selectedUser !== '__all__') qs.set('user', state.selectedUser);
      if(state.selectedDifficulty && state.selectedDifficulty !== 'all') qs.set('difficulty', state.selectedDifficulty);
      if(state.searchQuery) qs.set('q', state.searchQuery);

      fetch(`${DASHBOARD_ENDPOINT}?${qs.toString()}`, { cache: 'no-store' })
        .then(res => {
          if(!res.ok) throw new Error(`fetch ${DASHBOARD_ENDPOINT} ${res.status}`);
          return res.json();
        })
        .then(data => {
          if(requestId !== state.requestId) return;
          state.loading = false;
          populateUserOptions(data);
          rememberUser();
          renderDashboard(data);
          syncUrl();
        })
        .catch(err => {
          if(requestId !== state.requestId) return;
          state.loading = false;
          setStatus(`データの取得に失敗しました: ${err.message}`, 'error');
        });
    }

    if(userSelect){
      userSelect.addEventListener('change', () => {
        state.selectedUser = userSelect.value || '__all__';
        rememberUser();
        fetchDashboard();
      });
    }

    if(difficultySelect){
      difficultySelect.addEventListener('change', () => {
        state.selectedDifficulty = difficultySelect.value || 'all';
        fetchDashboard();
      });
    }

    const applyButton = $('#btn-apply');
    if(applyButton){
      applyButton.addEventListener('click', () => {
        state.searchQuery = (searchInput && searchInput.value ? searchInput.value.trim() : '');
        fetchDashboard();
      });
    }

    if(searchInput){
      searchInput.addEventListener('keydown', (ev) => {
        if(ev.key === 'Enter'){
          ev.preventDefault();
          state.searchQuery = searchInput.value.trim();
          fetchDashboard();
        }
      });
    }

    const clearButton = $('#btn-clear');
    if(clearButton){
      clearButton.addEventListener('click', () => {
        state.selectedUser = '__all__';
        state.selectedDifficulty = 'all';
        state.searchQuery = '';
        if(userSelect) userSelect.value = '__all__';
        if(difficultySelect) difficultySelect.value = 'all';
        if(searchInput) searchInput.value = '';
        rememberUser();
        fetchDashboard();
      });
    }

    fetchDashboard();
  </script>
</body>
</html>
